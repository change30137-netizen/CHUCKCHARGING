<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程實績地圖 | EV Charging Project Map</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }
        /* RWD: Mobile first */
        #main-container {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
            flex-direction: column-reverse; /* 手機版列表在下 */
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            #main-container {
                flex-direction: row; /* 電腦版列表在左 */
            }
            #sidebar {
                width: 400px;
                height: 100%;
                z-index: 20;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
        }

        #sidebar {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Mobile specific sidebar */
            height: 40vh; 
            width: 100%;
        }

        #map-wrapper {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* 滾動條美化 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 卡片互動效果 */
        .project-card {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .project-card:hover {
            background-color: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .project-card.active {
            background-color: #ecfdf5; /* 淺綠色背景 */
            border-left: 4px solid #10b981; /* 綠色邊條 */
        }
        /* 缺座標的卡片樣式 */
        .project-card.missing-coords {
            opacity: 0.7;
            background-color: #fff1f2; /* 紅色背景 */
            border-left: 4px solid #f43f5e;
        }

        /* 修復進度條 */
        #fix-progress {
            display: none;
            background: #1e293b;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 隱藏 Iframe 用於 Ragic 寫入 (Code of Conduct Rule #1) -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
    
    <!-- 隱藏 Form 用於提交資料 -->
    <form id="ragic_form" target="hidden_iframe" method="POST" style="display:none;"></form>

    <!-- Header -->
    <header class="bg-slate-800 text-white p-4 shadow-md flex justify-between items-center z-30">
        <div class="flex items-center gap-3">
            <i class="fas fa-charging-station text-green-400 text-2xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wide">EV Charging Map</h1>
                <p class="text-xs text-slate-400">工程實績展示系統</p>
            </div>
        </div>
        <div class="text-sm">
            <span id="project-count" class="bg-green-600 px-3 py-1 rounded-full text-xs font-bold">載入中...</span>
        </div>
    </header>

    <div id="main-container">
        <!-- Sidebar: List & Filter -->
        <aside id="sidebar">
            <!-- Filter Section -->
            <div class="p-4 border-b bg-white z-10 space-y-2">
                <div class="relative">
                    <i class="fas fa-filter absolute left-3 top-3 text-gray-400"></i>
                    <select id="category-filter" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 appearance-none bg-white cursor-pointer text-sm font-medium text-gray-700">
                        <option value="all">顯示所有案件類型</option>
                        <!-- options will be injected by JS -->
                    </select>
                    <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                </div>
                
                <!-- Admin Tools: Fix Data Button -->
                <div id="admin-tools" class="hidden bg-red-50 border border-red-200 rounded p-2 flex justify-between items-center">
                    <div class="text-xs text-red-700 font-bold">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <span id="missing-count">0</span> 筆資料缺座標
                    </div>
                    <button onclick="startAutoFix()" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded transition shadow-sm font-bold">
                        <i class="fas fa-magic mr-1"></i> 自動修復
                    </button>
                </div>
            </div>

            <!-- Fix Progress Bar -->
            <div id="fix-progress">
                <span><i class="fas fa-sync fa-spin mr-2"></i> 正在修復資料...</span>
                <span id="fix-status" class="font-mono text-yellow-400">0%</span>
            </div>

            <!-- Project List -->
            <div id="project-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2 bg-gray-50">
                <!-- Template for Loading -->
                <div class="text-center py-10 text-gray-500">
                    <i class="fas fa-circle-notch fa-spin text-2xl text-green-500 mb-2"></i>
                    <p>正在連線至資料庫...</p>
                </div>
            </div>
        </aside>

        <!-- Map Section -->
        <main id="map-wrapper">
            <div id="map"></div>
            
            <!-- Floating Controls (Optional) -->
            <button onclick="resetMap()" class="absolute bottom-6 right-6 bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 z-10 transition text-gray-700" title="回到全覽">
                <i class="fas fa-compress-arrows-alt"></i>
            </button>
        </main>
    </div>

    <!-- CONFIGURATION & LOGIC -->
    <script>
        /**
         * CTO CONFIGURATION ZONE
         */
        const CONFIG = {
            // Ragic 表單 API URL (末端不帶參數)
            RAGIC_API_URL: 'https://ap13.ragic.com/ChuckChargingCC/ragicproject-management/7', 
            
            // Google Maps API Key
            GOOGLE_MAPS_API_KEY: 'AIzaSyDIYt9AZImHlL7xpb-30cyYOuAXsFufufw',

            // 欄位對應表 (Field Mapping)
            FIELDS: {
                NAME:       1000167, // 專案名稱
                ADDRESS:    1000190, // 詳細地址
                COORDS:     1000417, // 經緯度 (將被寫入的欄位)
                CATEGORY:   1000372, // 案件類型
                DATE:       1000176  // 列案日期
            },

            // 地圖設定
            MAP_CENTER: { lat: 23.6, lng: 120.9 }, // 台灣中心
            MAP_ZOOM: 7
        };

        // 全域變數
        let map;
        let geocoder;
        let markers = [];
        let allProjects = [];
        let infoWindow;

        /**
         * 1. 初始化 Google Maps
         */
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: CONFIG.MAP_ZOOM,
                center: CONFIG.MAP_CENTER,
                styles: [
                    { "featureType": "poi", "stylers": [{ "visibility": "off" }] },
                    { "featureType": "transit", "stylers": [{ "visibility": "off" }] }
                ],
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false
            });

            infoWindow = new google.maps.InfoWindow();
            geocoder = new google.maps.Geocoder();

            // 地圖載入後，開始抓取資料
            fetchRagicData();
        }

        /**
         * 2. 抓取 Ragic 資料 (使用 JSONP)
         */
        function fetchRagicData() {
            window.ragicCallback = function(response) {
                const rawData = Object.values(response || {});
                processData(rawData);
            };

            const script = document.createElement('script');
            script.src = `${CONFIG.RAGIC_API_URL}?api&callback=ragicCallback`; 
            script.onerror = () => {
                document.getElementById('project-list').innerHTML = 
                    `<div class="p-4 text-red-500 text-center">無法連線至資料庫。<br>請檢查 API URL。</div>`;
            };
            document.body.appendChild(script);
        }

        /**
         * 3. 資料處理 (允許顯示無座標資料)
         */
        function processData(data) {
            let missingCount = 0;

            allProjects = data.map(record => {
                const latLngStr = record[CONFIG.FIELDS.COORDS];
                let position = null;

                // 解析座標
                if (latLngStr && latLngStr.includes(',')) {
                    const [lat, lng] = latLngStr.split(',').map(Number);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // 隱私抖動
                        const jitter = () => (Math.random() - 0.5) * 0.0015; 
                        position = { 
                            lat: lat + jitter(), 
                            lng: lng + jitter() 
                        };
                    }
                } else {
                    missingCount++;
                }

                return {
                    id: record._ragicId, // Ragic Record ID
                    name: record[CONFIG.FIELDS.NAME] || '未命名專案',
                    fullAddress: record[CONFIG.FIELDS.ADDRESS] || '',
                    displayAddress: getFuzzyAddress(record[CONFIG.FIELDS.ADDRESS] || ''),
                    category: record[CONFIG.FIELDS.CATEGORY] || '其他工程',
                    date: record[CONFIG.FIELDS.DATE] || '',
                    position: position,
                    hasCoords: position !== null // 標記是否有座標
                };
            });

            // 依日期排序 (新 -> 舊)
            allProjects.sort((a, b) => new Date(b.date) - new Date(a.date));

            // 初始化 UI
            initFilters();
            renderProjects(allProjects);
            updateMapMarkers(allProjects);

            // 如果有缺座標，顯示修復工具
            if (missingCount > 0) {
                document.getElementById('admin-tools').classList.remove('hidden');
                document.getElementById('missing-count').textContent = missingCount;
            } else {
                document.getElementById('admin-tools').classList.add('hidden');
            }
        }

        function getFuzzyAddress(fullAddr) {
            const match = fullAddr.match(/.*?[縣市].*?[區鄉鎮市]/);
            if (match) return match[0] + " ...";
            if (fullAddr.length > 6) return fullAddr.substring(0, 6) + "...";
            return fullAddr;
        }

        /**
         * 4. 渲染列表 (處理無座標樣式)
         */
        function renderProjects(projects) {
            const container = document.getElementById('project-list');
            const countBadge = document.getElementById('project-count');
            
            countBadge.textContent = `${projects.length} 件實績`;
            container.innerHTML = '';

            if (projects.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-400">沒有符合條件的案件</div>`;
                return;
            }

            projects.forEach(p => {
                const card = document.createElement('div');
                // 無座標加上 missing-coords 樣式
                card.className = `project-card p-4 bg-white rounded-lg cursor-pointer border border-gray-100 shadow-sm mb-2 ${!p.hasCoords ? 'missing-coords' : ''}`;
                card.dataset.id = p.id;
                
                const warningIcon = !p.hasCoords ? '<i class="fas fa-exclamation-circle text-red-500 mr-1" title="無地圖座標"></i>' : '<i class="fas fa-map-marker-alt w-4 text-center mr-1"></i>';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100">
                            ${p.category}
                        </span>
                        <span class="text-xs text-gray-400">${p.date}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-1 truncate">${p.name}</h3>
                    <div class="flex items-center text-gray-500 text-sm">
                        ${warningIcon}
                        <span class="truncate">${p.displayAddress}</span>
                    </div>
                `;

                if (p.hasCoords) {
                    card.addEventListener('click', () => {
                        focusOnProject(p);
                        document.querySelectorAll('.project-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                    });
                } else {
                    card.style.cursor = 'default';
                }

                container.appendChild(card);
            });
        }

        /**
         * 5. 更新地圖標記 (只顯示有的)
         */
        function updateMapMarkers(projects) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            const bounds = new google.maps.LatLngBounds();
            let hasPoints = false;

            projects.forEach(p => {
                if (!p.hasCoords) return;

                const marker = new google.maps.Marker({
                    position: p.position,
                    map: map,
                    title: p.name
                });

                marker.addListener('click', () => {
                    focusOnProject(p);
                    const card = document.querySelector(`.project-card[data-id="${p.id}"]`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        document.querySelectorAll('.project-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                    }
                });

                markers.push(marker);
                bounds.extend(p.position);
                hasPoints = true;
            });

            if (hasPoints) {
                map.fitBounds(bounds);
            }
        }

        function focusOnProject(p) {
            if (!p.hasCoords) return;
            map.panTo(p.position);
            map.setZoom(16);

            const contentString = `
                <div class="p-2 min-w-[200px]">
                    <h3 class="font-bold text-lg mb-1">${p.name}</h3>
                    <p class="text-sm text-green-600 font-bold mb-2">${p.category}</p>
                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${p.displayAddress}</p>
                    <p class="text-xs text-gray-400">完工: ${p.date}</p>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${p.fullAddress}" target="_blank" class="block mt-3 text-center bg-blue-500 text-white text-xs py-1.5 rounded hover:bg-blue-600 transition">
                        <i class="fas fa-directions mr-1"></i> 導航前往
                    </a>
                </div>
            `;
            
            infoWindow.setContent(contentString);
            infoWindow.setPosition(p.position);
            infoWindow.open(map);
        }

        function initFilters() {
            const select = document.getElementById('category-filter');
            const categories = [...new Set(allProjects.map(p => p.category))].filter(Boolean).sort();
            
            select.innerHTML = '<option value="all">顯示所有案件類型</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                const val = e.target.value;
                const filtered = val === 'all' ? allProjects : allProjects.filter(p => p.category === val);
                renderProjects(filtered);
                updateMapMarkers(filtered);
            });
        }

        function resetMap() {
            if(allProjects.length > 0) updateMapMarkers(allProjects);
            document.getElementById('category-filter').value = 'all';
            renderProjects(allProjects);
        }

        /**
         * =========================================
         * CTO 核心功能: 自動修復資料 (Auto Fix Data)
         * =========================================
         */
        async function startAutoFix() {
            const missing = allProjects.filter(p => !p.hasCoords && p.fullAddress);
            if (missing.length === 0) return;

            if (!confirm(`即將修復 ${missing.length} 筆資料的座標。\n此過程會呼叫 Google API 並寫回 Ragic。\n請勿關閉視窗。`)) return;

            const btn = document.querySelector('#admin-tools button');
            const progress = document.getElementById('fix-progress');
            const status = document.getElementById('fix-status');
            
            btn.disabled = true;
            btn.textContent = '修復中...';
            progress.style.display = 'flex';

            let successCount = 0;

            for (let i = 0; i < missing.length; i++) {
                const p = missing[i];
                status.textContent = `${i + 1} / ${missing.length}`;

                try {
                    // 1. Google Geocoding
                    const coords = await getCoordinates(p.fullAddress);
                    console.log(`Geocoded ${p.name}: ${coords}`);

                    // 2. 寫入 Ragic (使用 hidden iframe 表單提交)
                    postToRagic(p.id, coords);
                    successCount++;

                } catch (err) {
                    console.error(`Error processing ${p.name}:`, err);
                }

                // 3. 延遲避免 API Rate Limit (每 1.2 秒一筆)
                await new Promise(r => setTimeout(r, 1200));
            }

            alert(`修復完成！成功處理 ${successCount} 筆。\n請重新整理網頁查看結果。`);
            location.reload();
        }

        // 使用 Promise 包裝 Google Geocoding
        function getCoordinates(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, function(results, status) {
                    if (status === 'OK') {
                        const loc = results[0].geometry.location;
                        resolve(`${loc.lat()},${loc.lng()}`);
                    } else {
                        reject(status);
                    }
                });
            });
        }

        // 使用 Hidden Form POST 寫回 Ragic
        function postToRagic(recordId, coordsValue) {
            const form = document.getElementById('ragic_form');
            form.innerHTML = ''; // 清空舊 input

            // Ragic API URL for specific record
            form.action = `${CONFIG.RAGIC_API_URL}/${recordId}`;

            // 建立 hidden input 對應座標欄位 ID
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = CONFIG.FIELDS.COORDS; // 1000417
            input.value = coordsValue;
            
            // Ragic 需要 API Key (如果權限非公開) 或直接 POST
            // 如果你的表單是公開可寫入 (Everyone Admin)，則不需要 Key
            // 如果需要 Key，請將 Key 加入 URL 參數 ?api&APIKey=...
            // 但為了安全，這裡假設我們利用瀏覽器 session 或公開權限
            
            form.appendChild(input);
            form.submit();
        }

    </script>

    <!-- Google Maps API Loader -->
    <script>
        (function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap&language=zh-TW`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        })();
    </script>
</body>
</html>
