<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Map v26.0 Fullscreen Immersive Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; height: 100vh; overflow: hidden; font-family: 'Microsoft JhengHei', sans-serif; background: #e2e8f0; }
        #app { width: 100vw; height: 100vh; position: relative; }
        
        /* Map Container */
        #map { width: 100%; height: 100%; }

        /* Google Maps InfoWindow æ¨£å¼å¾®èª¿ (éš±è—é è¨­æ»¾å‹•æ¢) */
        .gm-style-iw-d { overflow: hidden !important; }
        
        /* ç‹€æ…‹åˆ—æ·¡å‡ºå‹•ç•« */
        .fade-out { opacity: 0; visibility: hidden; transition: opacity 1s ease-out, visibility 1s ease-out; }
    </style>
</head>
<body>

    <div id="app">
        <!-- Google Map å°‡æ¸²æŸ“æ–¼æ­¤ -->
        <div id="map"></div>

        <!-- æ‡¸æµ®åœ–ä¾‹èªªæ˜ (å·¦ä¸Šè§’) -->
        <div class="absolute top-5 left-5 bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow-lg z-10 border border-slate-200">
            <div class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-200 pb-1 flex items-center gap-2">
                <i class="fas fa-map-marked-alt text-blue-500"></i> å·¥ç¨‹å¯¦ç¸¾åœ–ä¾‹
            </div>
            <div class="flex flex-col gap-2.5 text-sm font-bold text-slate-600">
                <div class="flex items-center gap-3">
                    <span class="w-4 h-4 rounded-full shadow-sm" style="background:#f97316"></span> å°ˆæ¡ˆå·¥ç¨‹
                </div>
                <div class="flex items-center gap-3">
                    <span class="w-4 h-4 rounded-full shadow-sm" style="background:#10b981"></span> ç¤¾å€å»ºç½®
                </div>
                <div class="flex items-center gap-3">
                    <span class="w-4 h-4 rounded-full shadow-sm" style="background:#3b82f6"></span> å®¶å……è¨­å‚™
                </div>
            </div>
        </div>

        <!-- æ‡¸æµ®ç³»çµ±ç‹€æ…‹åˆ— (é ‚éƒ¨ç½®ä¸­) -->
        <div id="status-overlay" class="absolute top-5 left-1/2 transform -translate-x-1/2 bg-slate-900/85 text-white px-5 py-2.5 rounded-full shadow-[0_4px_20px_rgba(0,0,0,0.3)] text-xs font-bold z-50 flex items-center gap-2.5 backdrop-blur-md transition-all duration-500">
            <i id="sys-status-icon" class="fas fa-spinner fa-spin text-blue-400 text-sm"></i> 
            <span id="sys-status-text" class="tracking-wide">ç³»çµ±åˆå§‹åŒ–...</span>
        </div>
    </div>

    <!-- Firebase v11 & æ ¸å¿ƒé‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ğŸš€ å…¨è‡ªå‹•è¨­å®šå€ (å¯«æ­»æ–¼ç¨‹å¼ä¸­)
        // ==========================================
        const CONFIG = {
            RAGIC_SERVER: "ap14",
            RAGIC_PATH: "ChuckChargingCC/ragicproject-management/7",
            MAP_KEY: "AIzaSyDIYt9AZImHlL7xpb-30cyYOuAXsFufufw",
            PREFILL_RAGIC_KEY: "aE9KcVErZy9iTTJQWDJCeWZLaFM2RUtQRXd2bGxnS1lxYm9PN0pPc1J2bmRzRnN2blRzTE9JSHNyQmpnM1dPVA==" 
        };

        const FIELDS = { NAME: "1000167", CAT: "1000372", ADDR: "1000190", COORDS: "1000417" };
        const COLORS = { "å°ˆæ¡ˆ": "#f97316", "å®¶å……": "#3b82f6", "ç¤¾å€": "#10b981", "default": "#64748b" };

        let map, geocoder, allData = [];
        let markers = [];
        let bounds;
        let globalInfoWindow = null; // å”¯ä¸€è³‡è¨Šè¦–çª—å¯¦ä¾‹
        
        let db, auth, currentUser;
        let cloudCache = {}; 
        
        // --- ç‹€æ…‹æ§åˆ¶å‡½å¼ (æ‡¸æµ®åˆ—) ---
        function setSysStatus(msg, iconClass, autoHide = false) {
            const overlay = document.getElementById('status-overlay');
            const textEl = document.getElementById('sys-status-text');
            const iconEl = document.getElementById('sys-status-icon');
            
            if (overlay && textEl && iconEl) {
                overlay.classList.remove('fade-out');
                textEl.innerText = msg;
                iconEl.className = iconClass;

                if (autoHide) {
                    setTimeout(() => { overlay.classList.add('fade-out'); }, 4000);
                }
            }
        }

        // --- å…§éƒ¨ Log (ä¸é¡¯ç¤ºæ–¼ç•«é¢ï¼Œåƒ…é–‹ç™¼è€…æŒ‰ F12 å¯è¦‹) ---
        function log(msg, type='info') {
            if (type === 'err') console.error(`[EV-Map] ${msg}`);
            else if (type === 'warn') console.warn(`[EV-Map] ${msg}`);
            else console.log(`[EV-Map] ${msg}`);
        }

        // --- Firebase åˆå§‹åŒ– ---
        const initFirebase = async () => {
            try {
                let firebaseConfig;
                let isPreviewEnv = false;
                
                if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config !== '{}') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    isPreviewEnv = true;
                } else {
                    firebaseConfig = {
                        apiKey: "AIzaSyCGqiHwPv2ero7SVmqN5gkyfqDh5o2AEjo",
                        authDomain: "ev-map-1470c.firebaseapp.com",
                        projectId: "ev-map-1470c",
                        storageBucket: "ev-map-1470c.firebasestorage.app",
                        messagingSenderId: "314662873363",
                        appId: "1:314662873363:web:d2124b85c423ab2bf7d2e6"
                    };
                }
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (isPreviewEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        setupFirestoreListener(isPreviewEnv);
                        setTimeout(() => { window.loadData(); }, 1000); // é€£ç·šæˆåŠŸå¾Œè¼‰å…¥è³‡æ–™
                    } else {
                        setSysStatus('ç³»çµ±æœªç™»å…¥', 'fas fa-exclamation-triangle text-red-400');
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                setSysStatus('è³‡æ–™åº«é€£ç·šç•°å¸¸ï¼Œæ­£åœ¨å˜—è©¦é›¢ç·šè¼‰å…¥', 'fas fa-wifi text-red-400');
                setTimeout(() => { window.loadData(); }, 1500); // å¤±æ•—é˜²å‘†
            }
        };

        // --- ç›£è½ Firestore å¿«å–è®Šæ›´ ---
        const setupFirestoreListener = (isPreviewEnv) => {
            if (!currentUser) return;
            const currentAppId = typeof __app_id !== 'undefined' && isPreviewEnv ? __app_id : 'ev-map-production';
            const cacheRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'coords_cache');
            
            onSnapshot(cacheRef, (snapshot) => {
                cloudCache = {}; 
                snapshot.forEach(docSnap => { cloudCache[docSnap.id] = docSnap.data(); });
                log(`é›²ç«¯å¿«å–åŒæ­¥å®Œæˆï¼Œå…± ${Object.keys(cloudCache).length} ç­†åº§æ¨™`, 'success');
                if (allData.length > 0) renderMarkersOnly();
            }, (error) => {
                log(`é›²ç«¯å¿«å–è®€å–éŒ¯èª¤: ${error.message}`, 'err');
            });
            window.currentAppId = currentAppId;
        };

        // --- Google Maps åˆå§‹åŒ– ---
        window.initMap = function() {
            try {
                const mapEl = document.getElementById("map");
                if (!mapEl) return;
                
                // åˆå§‹åŒ–åœ°åœ–ï¼Œéš±è—å¤šé¤˜æ§åˆ¶é …ä¿æŒç‰ˆé¢ä¹¾æ·¨
                map = new google.maps.Map(mapEl, { 
                    center: { lat: 23.6, lng: 120.9 }, 
                    zoom: 8, 
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true
                });
                
                geocoder = new google.maps.Geocoder();
                bounds = new google.maps.LatLngBounds();
                globalInfoWindow = new google.maps.InfoWindow(); // å…¨åŸŸå…±ç”¨çš„è³‡è¨Šè¦–çª—
                
                log("Google Maps API è¼‰å…¥å®Œæˆ", "info");
            } catch (e) { 
                log("åœ°åœ–è¼‰å…¥å¤±æ•—: " + e.message, "err"); 
                setSysStatus('åœ°åœ–è¼‰å…¥å¤±æ•—', 'fas fa-exclamation-circle text-red-400');
            }
        };

        // --- ç¹ªè£½è‡ªè¨‚åœ–é‡˜ ---
        function getCustomPin(color) {
            const width = 36; const height = 48;
            const svgData = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="${width}" height="${height}">
                    <path fill="${color}" stroke="#ffffff" stroke-width="2" d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0z"/>
                    <circle cx="192" cy="192" r="85" fill="#ffffff" />
                    <path fill="${color}" d="M207.3 261.2c-2.4 4.5-8.5 5.5-12.3 2L135 225.5c-3-2.8-3.9-7.1-2.2-10.9L157.4 160H122c-4.4 0-8-3.6-8-8v-16c0-4.4 3.6-8 8-8h80c5.4 0 9.4 5.2 7.9 10.4l-19.4 69.6h31.5c4.7 0 8.7 3.2 9.8 7.8 1.1 4.5-1.1 9.2-5.1 11.2l-35.4 24.2z"/>
                </svg>`;
            return {
                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svgData)}`,
                scaledSize: new google.maps.Size(width, height),
                anchor: new google.maps.Point(width/2, height)
            };
        }

        // --- 1. è®€å– Ragic è³‡æ–™èˆ‡éš±ç§è™•ç† ---
        window.loadData = function() {
            setSysStatus('æ­£åœ¨åŒæ­¥å³æ™‚è³‡æ–™åº«...', 'fas fa-sync-alt fa-spin text-blue-400');

            const key = CONFIG.PREFILL_RAGIC_KEY;
            const url = `https://${CONFIG.RAGIC_SERVER}.ragic.com/${CONFIG.RAGIC_PATH}?api&naming=EID&APIKey=${encodeURIComponent(key)}&callback=ragicCallback`;

            window.ragicCallback = function(res) {
                if (!res || res.status === 'ERROR') {
                    setSysStatus('è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ', 'fas fa-exclamation-triangle text-red-400');
                    return;
                }
                
                let data = Object.values(res);

                // éæ¿¾ç©ºåœ°å€èˆ‡ç‰¹å®šæ¡ˆä»¶ï¼Œä¸¦åŸ·è¡Œéš±ç§æ¨¡ç³ŠåŒ–
                data = data.filter(item => {
                    const addr = item[FIELDS.ADDR];
                    const name = item[FIELDS.NAME] || '';
                    
                    // éæ¿¾æ‰åç¨±åŒ…å«ã€Œé…·æ¾å€‰åº«ã€çš„æ¡ˆä»¶
                    if (name.includes('é…·æ¾å€‰åº«')) {
                        return false;
                    }
                    
                    return addr && typeof addr === 'string' && addr.trim().length > 0;
                }).map(item => {
                    const cat = item[FIELDS.CAT] || '';
                    if (cat === 'å®¶å……') {
                        const name = item[FIELDS.NAME] || '';
                        if (name.length > 0) item[FIELDS.NAME] = name.charAt(0) + 'å®…';
                        
                        const addr = item[FIELDS.ADDR] || '';
                        if (addr) {
                            const match = addr.match(/(.*?(?:è·¯|è¡—|å¤§é“)(?:[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+æ®µ)?)/);
                            if (match) {
                                item[FIELDS.ADDR] = match[1];
                            } else {
                                const idx = addr.search(/[\då··å¼„è™Ÿæ¨“]/);
                                if (idx !== -1) item[FIELDS.ADDR] = addr.substring(0, idx);
                            }
                        }
                    }
                    return item;
                });
                
                allData = data;
                renderMarkersOnly(); 

                // æª¢æŸ¥æ˜¯å¦éœ€è¦å•Ÿå‹•èƒŒæ™¯è§£æ
                let needsSync = false;
                for (let i = 0; i < allData.length; i++) {
                    const coordsRaw = allData[i][FIELDS.COORDS];
                    const docId = allData[i][FIELDS.NAME] || allData[i]._ragicId;
                    const hasOriginalCoords = coordsRaw && coordsRaw.includes(',') && !isNaN(parseFloat(coordsRaw.split(',')[0]));
                    const hasCache = !!cloudCache[docId];
                    if (!hasOriginalCoords && !hasCache) {
                        needsSync = true; break;
                    }
                }
                
                if (needsSync) {
                    setSysStatus('ç™¼ç¾æ–°å·¥ç¨‹ï¼Œæ­£åœ¨ç¹ªè£½åœ°åœ–...', 'fas fa-cogs fa-spin text-yellow-400');
                    setTimeout(() => { window.startDynamicMapping(); }, 1500);
                } else {
                    // è‹¥ç„¡æ–°è³‡æ–™ï¼Œæç¤ºæˆåŠŸä¸¦æ–¼ 4 ç§’å¾Œæ·¡å‡ºéš±è—
                    setSysStatus('âœ… åœ°åœ–è³‡æ–™å·²æ˜¯æœ€æ–°ç‹€æ…‹', 'fas fa-check-circle text-green-400', true);
                }
            };

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => { setSysStatus('ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œç„¡æ³•è®€å–è³‡æ–™', 'fas fa-wifi text-red-400'); };
            document.body.appendChild(script);
        };

        // --- å°‡æ‰€æœ‰è³‡æ–™è½‰åŒ–ç‚ºåœ–é‡˜ (ç„¡å·¦å´é¸å–®) ---
        function renderMarkersOnly() {
            // æ¸…é™¤èˆŠåœ–é‡˜
            markers.forEach(m => m.setMap(null));
            markers = [];
            bounds = new google.maps.LatLngBounds();

            allData.forEach((item) => {
                const id = item._ragicId;
                const name = item[FIELDS.NAME] || '(ç„¡åç¨±)';
                const addr = item[FIELDS.ADDR];
                const cat = item[FIELDS.CAT] || 'æœªåˆ†é¡';
                const coordsRaw = item[FIELDS.COORDS];
                
                const color = COLORS[cat] || COLORS['default'];
                
                const hasOriginalCoords = coordsRaw && coordsRaw.includes(',') && !isNaN(parseFloat(coordsRaw.split(',')[0]));
                const docId = name || id; 
                const cacheData = cloudCache[docId];
                const hasCache = !!cacheData;
                
                // å„ªå…ˆä½¿ç”¨ Ragic åŸç”Ÿåº§æ¨™ï¼Œå…¶æ¬¡ä½¿ç”¨ Firebase å¿«å–åº§æ¨™
                if (hasOriginalCoords) {
                    const [lat, lng] = coordsRaw.split(',').map(Number);
                    addMarkerToMap(id, name, addr, lat, lng, color, cat);
                } else if (hasCache && cacheData.coords) {
                    const [lat, lng] = cacheData.coords.split(',').map(Number);
                    addMarkerToMap(id, name, addr, lat, lng, color, cat);
                }
            });
            
            // åœ°åœ–è‡ªå‹•ç¸®æ”¾ä»¥åŒ…å«æ‰€æœ‰åœ–é‡˜
            if (markers.length > 0) map.fitBounds(bounds);
        }

        // --- 2. å•Ÿå‹•å‹•æ…‹è§£æä¸¦ä¸Šå‚³ Firebase (èƒŒæ™¯åŸ·è¡Œ) ---
        window.startDynamicMapping = async function() {
            if (!geocoder || !currentUser) return;

            for (let i = 0; i < allData.length; i++) {
                const item = allData[i];
                const id = item._ragicId;
                const name = item[FIELDS.NAME] || 'æœªå‘½å';
                const addr = item[FIELDS.ADDR];
                const coordsRaw = item[FIELDS.COORDS];
                const cat = item[FIELDS.CAT] || 'æœªåˆ†é¡';
                const color = COLORS[cat] || COLORS['default'];

                const hasOriginalCoords = coordsRaw && coordsRaw.includes(',') && !isNaN(parseFloat(coordsRaw.split(',')[0]));
                const docId = name || id;
                const hasCache = !!cloudCache[docId];
                
                if (!hasOriginalCoords && !hasCache) {
                    let success = false;
                    let retries = 0;

                    while (!success && retries < 3) {
                        try {
                            const loc = await new Promise((resolve, reject) => {
                                geocoder.geocode({ address: addr }, (res, status) => {
                                    if (status === 'OK' && res.length > 0) resolve(res[0].geometry.location);
                                    else reject(status);
                                });
                            });

                            const lat = loc.lat();
                            const lng = loc.lng();
                            const coordsStr = `${lat},${lng}`;

                            // å¯«å…¥ Firebase
                            const targetAppId = window.currentAppId || 'ev-map-production';
                            const docRef = doc(db, 'artifacts', targetAppId, 'public', 'data', 'coords_cache', docId);
                            await setDoc(docRef, { coords: coordsStr, address: addr, updatedAt: new Date().toISOString() });

                            addMarkerToMap(id, name, addr, lat, lng, color, cat);
                            success = true;
                        } catch (e) {
                            if (e === 'OVER_QUERY_LIMIT') {
                                retries++;
                                await new Promise(r => setTimeout(r, 2000));
                            } else {
                                break;
                            }
                        }
                    }
                    await new Promise(r => setTimeout(r, 800)); 
                }
            }

            // å®Œæˆå¾Œé¡¯ç¤ºç¶ å‹¾å‹¾ï¼Œä¸¦åœ¨ 4 ç§’å¾Œæ·¡å‡º
            setSysStatus('âœ… åœ°åœ–è³‡æ–™å·²æ˜¯æœ€æ–°ç‹€æ…‹', 'fas fa-check-circle text-green-400', true);
            if (markers.length > 0) map.fitBounds(bounds);
        }

        // --- æ ¸å¿ƒï¼šå»ºç«‹åœ–é‡˜èˆ‡ç²¾ç¾é»æ“Šè³‡è¨Šå¡ ---
        function addMarkerToMap(id, name, addr, lat, lng, color, cat) {
            let markerZIndex = 1;
            if (cat === 'å°ˆæ¡ˆ' || cat === 'ç¤¾å€') markerZIndex = 1000;
            else if (cat === 'å®¶å……') markerZIndex = 10;

            const marker = new google.maps.Marker({
                position: {lat, lng}, 
                map: map, 
                title: name, 
                icon: getCustomPin(color), 
                zIndex: markerZIndex
            });
            
            // é»æ“Šäº‹ä»¶ï¼šæ‰“é–‹å®¢è£½åŒ–çš„ InfoWindow
            marker.addListener('click', () => {
                // å®Œç¾é‚„åŸä½¿ç”¨è€…æä¾›çš„æˆªåœ–æ¨£å¼
                const contentHtml = `
                    <div style="font-family: 'Microsoft JhengHei', sans-serif; min-width: 220px; max-width: 280px; padding: 2px 0;">
                        <div style="border-left: 5px solid ${color}; padding-left: 10px;">
                            <span style="background-color: ${color}; color: white; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block;">
                                ${cat}
                            </span>
                            <h3 style="margin: 8px 0 6px 0; font-size: 15px; font-weight: 800; color: #1f2937; line-height: 1.3;">
                                ${name}
                            </h3>
                            <p style="margin: 0; font-size: 12px; color: #6b7280; display: flex; align-items: flex-start; gap: 6px; font-weight: 500;">
                                <i class="fas fa-map-marker-alt" style="color: #9ca3af; margin-top: 2px;"></i> 
                                <span>${addr}</span>
                            </p>
                        </div>
                    </div>
                `;

                globalInfoWindow.setContent(contentHtml);
                globalInfoWindow.open({
                    anchor: marker,
                    map,
                    shouldFocus: false
                });

                // å°‡åœ°åœ–ä¸­å¿ƒç§»è‡³è©²åœ–é‡˜ä¸¦ç¨å¾®æ”¾å¤§
                map.panTo({lat, lng});
                if (map.getZoom() < 14) map.setZoom(14);
            });
            
            markers.push(marker);
            bounds.extend({lat, lng});
        }

        // --- é é¢å•Ÿå‹•ç¨‹åº ---
        window.addEventListener('DOMContentLoaded', () => {
            initFirebase(); 
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.MAP_KEY}&callback=initMap&language=zh-TW`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        });

    </script>
</body>
</html>
