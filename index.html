<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Map v14.0 Deep Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; height: 100vh; display: flex; flex-direction: column; font-family: 'Microsoft JhengHei', sans-serif; background: #f1f5f9; }
        #app { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 450px; background: #fff; display: flex; flex-direction: column; border-right: 1px solid #cbd5e1; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        #sidebar-header { padding: 12px; background: #0f172a; color: white; }
        #project-list { flex: 1; overflow-y: auto; background: #f8fafc; padding: 10px; }
        
        /* Map */
        #map { flex: 1; background: #e2e8f0; position: relative; }
        
        /* Components */
        .card { 
            background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid #cbd5e1;
            transition: all 0.2s; position: relative;
        }
        .card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .action-btn { 
            width: 100%; border: none; padding: 8px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; margin-top: 5px; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: background 0.2s;
        }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        
        .btn-red { background: #ef4444; color: white; }
        .btn-red:hover { background: #dc2626; }
        .btn-red:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        
        /* Debug Specific */
        .btn-debug { 
            background: #b91c1c; color: white; border: 1px solid #fca5a5;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .api-input {
            width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid #475569; 
            background: #334155; color: white; font-size: 12px; margin-bottom: 4px;
        }
        .api-input:focus { outline: 2px solid #60a5fa; border-color: transparent; }

        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
        .config-label { font-size: 10px; color: #94a3b8; }
        
        .log-window {
            background: #0f172a; color: #4ade80; padding: 8px; font-family: monospace; font-size: 11px;
            height: 200px; overflow-y: auto; border-top: 4px solid #f59e0b;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; word-break: break-all; }
        .curl-box {
            background: #334155; color: #e2e8f0; padding: 8px; margin: 4px 0; border-radius: 4px;
            font-size: 10px; user-select: all; word-break: break-all; border: 1px dashed #64748b;
        }
    </style>
</head>
<body>

    <!-- æ ¸å¿ƒæŠ€è¡“ï¼šéš±è— iframe ç”¨æ–¼è·¨åŸŸå¯«å…¥ -->
    <iframe name="hidden_iframe" style="display:none;"></iframe>
    <form id="ragic_form" target="hidden_iframe" method="POST" style="display:none;"></form>

    <div id="app">
        <!-- Sidebar -->
        <div id="sidebar">
            <div id="sidebar-header">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-bug text-red-400"></i> å·¥ç¨‹å¯¦ç¸¾åœ°åœ– v14
                    </h1>
                    <span class="text-[10px] bg-red-900 px-2 py-1 rounded text-red-200">æ·±åº¦é™¤éŒ¯ç‰ˆ</span>
                </div>
                
                <!-- Main Config -->
                <div>
                    <input type="password" id="api-key" class="api-input" placeholder="è²¼ä¸Š Ragic API Key">
                    <div class="flex gap-2">
                        <select id="server-select" class="api-input w-1/3 py-1">
                            <option value="ap14">ap14</option>
                            <option value="ap13">ap13</option>
                        </select>
                        <button onclick="loadData()" class="action-btn btn-blue mt-0 py-1 relative">
                            <i class="fas fa-sync-alt"></i> è¼‰å…¥è³‡æ–™
                        </button>
                    </div>
                </div>

                <!-- Field Settings (å¯æŠ˜ç–Š) -->
                <div class="mt-2 pt-2 border-t border-slate-600">
                    <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('field-config').classList.toggle('hidden')">
                        <span class="text-xs text-slate-300 font-bold"><i class="fas fa-cog"></i> æ¬„ä½ ID è¨­å®š</span>
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                    <div id="field-config" class="hidden">
                        <div class="config-grid">
                            <div><div class="config-label">åç¨± ID</div><input id="fid-name" class="api-input" value="1000167"></div>
                            <div><div class="config-label">é¡åˆ¥ ID</div><input id="fid-cat" class="api-input" value="1000372"></div>
                            <div><div class="config-label">åœ°å€ ID</div><input id="fid-addr" class="api-input" value="1000190"></div>
                            <div><div class="config-label">åº§æ¨™ ID</div><input id="fid-coords" class="api-input" value="1000417"></div>
                        </div>
                        <button onclick="applyFields()" class="w-full bg-slate-600 hover:bg-slate-500 text-white text-[10px] py-1 rounded mt-1">æ›´æ–°è¨­å®šä¸¦é‡ç¹ª</button>
                    </div>
                </div>

                <!-- Debug Tools -->
                <div id="tools-panel" class="hidden mt-4 pt-4 border-t border-slate-600">
                    <div class="text-xs text-slate-300 mb-2 font-bold">é™¤éŒ¯ç›®æ¨™ï¼š</div>
                    <div class="bg-slate-800 p-2 rounded text-[10px] text-slate-400 mb-2">
                        <div>åç¨±: <span class="text-white">å€å¡Šè­‰-é¾œå±±ç¾å…‰æ¡ˆ</span></div>
                        <div>åœ°å€: <span class="text-white">æ¡ƒåœ’å¸‚é¾œå±±å€å¾©èˆˆä¸‰è·¯667è™Ÿ</span></div>
                    </div>
                    
                    <button onclick="runDebugMode()" id="btn-debug" class="action-btn btn-debug">
                        <i class="fas fa-microscope"></i> åŸ·è¡Œå–®ç­†é™¤éŒ¯ (Debug)
                    </button>
                    <div class="text-[10px] text-gray-400 mt-1 text-center">
                        <i class="fas fa-info-circle"></i> åƒ…æ¸¬è©¦ä¸€ç­†ï¼Œä¸æœƒæ¶ˆè€—å¤§é‡é¡åº¦
                    </div>
                </div>
            </div>

            <div id="project-list">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 text-sm">
                    <i class="fas fa-arrow-up mb-2 text-2xl animate-bounce"></i>
                    <span>è«‹è¼¸å…¥ Key ä¸¦è¼‰å…¥è³‡æ–™</span>
                </div>
            </div>

            <div id="log-window" class="log-window hidden">
                <div class="text-yellow-400 border-b border-gray-700 pb-1 mb-1 flex justify-between">
                    <span>> ç³»çµ±æ—¥èªŒ</span>
                    <span class="text-[9px] cursor-pointer hover:text-white" onclick="document.getElementById('log-window').innerHTML=''">[æ¸…é™¤]</span>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>
    </div>

    <script>
        // --- Global State ---
        let CONFIG = {
            RAGIC_PATH: "ChuckChargingCC/ragicproject-management/7",
            MAP_KEY: "AIzaSyDIYt9AZImHlL7xpb-30cyYOuAXsFufufw",
            TEST_NAME: "å€å¡Šè­‰-é¾œå±±ç¾å…‰æ¡ˆ",
            TEST_ADDR: "æ¡ƒåœ’å¸‚é¾œå±±å€å¾©èˆˆä¸‰è·¯667è™Ÿ"
        };
        
        let FIELDS = {
            NAME: "1000167", CAT: "1000372", ADDR: "1000190", COORDS: "1000417"
        };

        let map, geocoder, allData = [], markers = [], currentApiKey = "";
        
        const COLORS = { "default": "#64748b", "å®¶ç”¨": "#3b82f6", "å•†ç”¨": "#10b981", "å…¬å…±": "#f59e0b", "å¿«å……": "#ef4444" };

        function log(msg, type='info') {
            const win = document.getElementById('log-window');
            win.classList.remove('hidden');
            const color = type === 'err' ? '#f87171' : type === 'warn' ? '#facc15' : '#4ade80';
            const time = new Date().toLocaleTimeString('zh-TW', {hour12:false});
            win.innerHTML += `<div class="log-entry" style="color:${color}">[${time}] ${msg}</div>`;
            win.scrollTop = win.scrollHeight;
        }

        function logCurl(url, data) {
            const win = document.getElementById('log-window');
            const curl = `curl -X POST "${url}" \\
     -d "${data}"`;
            win.innerHTML += `
                <div style="color:#cbd5e1; margin-top:4px;">è‹¥ç¶²é å¯«å…¥ç„¡æ•ˆï¼Œè«‹è¤‡è£½ä¸‹æ–¹æŒ‡ä»¤è‡³çµ‚ç«¯æ©Ÿæ¸¬è©¦æ¬Šé™ï¼š</div>
                <div class="curl-box">${curl}</div>
            `;
            win.scrollTop = win.scrollHeight;
        }

        function initMap() {
            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 23.6, lng: 120.9 }, zoom: 8, mapTypeControl: false
                });
                geocoder = new google.maps.Geocoder();
                log("Google Maps API è¼‰å…¥æˆåŠŸ");
            } catch (e) { log("åœ°åœ–è¼‰å…¥å¤±æ•—: " + e.message, "err"); }
        }

        // --- Data Loading ---
        function loadData() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) return alert("è«‹è¼¸å…¥ Ragic API Key");
            currentApiKey = key;

            FIELDS.NAME = document.getElementById('fid-name').value;
            FIELDS.CAT = document.getElementById('fid-cat').value;
            FIELDS.ADDR = document.getElementById('fid-addr').value;
            FIELDS.COORDS = document.getElementById('fid-coords').value;

            const server = document.getElementById('server-select').value;
            const url = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}?api&naming=EID&APIKey=${encodeURIComponent(key)}&callback=ragicCallback`;

            log(`é€£ç·šä¸­ (${server})...`, "info");
            
            window.ragicCallback = function(res) {
                if (!res || res.status === 'ERROR') {
                    log(`API éŒ¯èª¤: ${res?.msg || 'æœªçŸ¥'}`, "err");
                    return alert("è®€å–å¤±æ•—ï¼è«‹æª¢æŸ¥ Key æˆ–åˆ‡æ›ä¼ºæœå™¨ã€‚");
                }
                
                let data = Object.values(res);
                const originalCount = data.length;
                log(`è®€å–: ${originalCount} ç­†`, "info");

                // éæ¿¾ç„¡åœ°å€ (æ–¹ä¾¿é™¤éŒ¯)
                data = data.filter(item => {
                    const addr = item[FIELDS.ADDR];
                    return addr && typeof addr === 'string' && addr.trim().length > 0;
                });
                
                allData = data;
                
                // æª¢æŸ¥æ¸¬è©¦è³‡æ–™æ˜¯å¦å­˜åœ¨
                const testExist = allData.find(d => d[FIELDS.NAME] === CONFIG.TEST_NAME);
                if (testExist) {
                    log(`âœ… æ‰¾åˆ°æ¸¬è©¦ç›®æ¨™ï¼š${CONFIG.TEST_NAME}`, "info");
                } else {
                    log(`âš ï¸ åˆ—è¡¨ä¸­æœªæ‰¾åˆ°ã€Œ${CONFIG.TEST_NAME}ã€ï¼Œå°‡ä½¿ç”¨ç¬¬ä¸€ç­†æœ‰åœ°å€çš„è³‡æ–™æ¸¬è©¦`, "warn");
                }

                if (data.length > 0) detectFieldIds(data[0]);

                document.getElementById('tools-panel').classList.remove('hidden');
                renderUI();
            };

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => log("é€£ç·šä¸­æ–· (Network Error)", "err");
            document.body.appendChild(script);
        }

        // --- Field Detection ---
        function detectFieldIds(record) {
            const currentAddrVal = record[FIELDS.ADDR];
            if (!currentAddrVal) {
                log("âš ï¸ ç•¶å‰åœ°å€ ID è®€å–ç‚ºç©ºï¼Œå˜—è©¦è‡ªå‹•æœå°‹...", "warn");
                Object.keys(record).forEach(k => {
                    const v = String(record[k]);
                    if (v.includes('å¸‚') && v.includes('å€') && v.length > 5) {
                        log(`ğŸ’¡ ç™¼ç¾ç–‘ä¼¼åœ°å€æ¬„ä½: ${k} (${v.substring(0,8)}...)`, "warn");
                        document.getElementById('fid-addr').value = k;
                        FIELDS.ADDR = k;
                        log("å·²è‡ªå‹•æ›´æ–°åœ°å€æ¬„ä½è¨­å®š", "info");
                    }
                });
            }
        }

        function applyFields() {
            FIELDS.NAME = document.getElementById('fid-name').value;
            FIELDS.CAT = document.getElementById('fid-cat').value;
            FIELDS.ADDR = document.getElementById('fid-addr').value;
            FIELDS.COORDS = document.getElementById('fid-coords').value;
            if (currentApiKey) loadData();
        }

        // --- Render ---
        function renderUI() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            markers.forEach(m => m.setMap(null));
            markers = [];

            if (allData.length === 0) {
                 list.innerHTML = '<div class="text-center p-5 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
                 return;
            }

            allData.forEach(item => {
                const name = item[FIELDS.NAME] || '(ç„¡åç¨±)';
                const addr = item[FIELDS.ADDR];
                const coords = item[FIELDS.COORDS];
                const cat = item[FIELDS.CAT] || 'default';
                
                const hasValidCoords = coords && coords.includes(',') && !isNaN(parseFloat(coords.split(',')[0]));

                const card = document.createElement('div');
                card.className = 'card';
                const color = COLORS[cat] || COLORS['default'];
                card.style.borderLeftColor = color;
                
                // Highlight test case
                const isTest = name === CONFIG.TEST_NAME;
                const borderClass = isTest ? 'border-2 border-red-500' : '';

                card.innerHTML = `
                    <div class="${borderClass} p-1 rounded">
                        <div class="flex justify-between mt-1">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded text-white" style="background:${color}">${cat}</span>
                            ${isTest ? '<span class="text-red-600 font-bold text-xs">æ¸¬è©¦ç›®æ¨™</span>' : ''}
                        </div>
                        <h3 class="font-bold text-gray-800 mt-1 text-sm">${name}</h3>
                        <p class="text-xs text-gray-500 mt-1 truncate"><i class="fas fa-map-marker-alt"></i> ${addr}</p>
                        <div class="mt-1 text-[10px] ${hasValidCoords ? 'text-green-600' : 'text-red-500'} font-bold">
                            ${hasValidCoords ? '<i class="fas fa-check"></i> å·²å®šä½' : '<i class="fas fa-times"></i> ç¼ºåº§æ¨™'}
                        </div>
                    </div>
                `;
                
                if (hasValidCoords) {
                    const [lat, lng] = coords.split(',').map(Number);
                    const marker = new google.maps.Marker({
                        position: {lat, lng}, map: map, title: name,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: '#fff' }
                    });
                    const clickFn = () => { map.panTo({lat, lng}); map.setZoom(16); };
                    marker.addListener('click', clickFn);
                    card.onclick = clickFn;
                    markers.push(marker);
                }
                
                list.appendChild(card);
            });
        }

        // --- æ ¸å¿ƒï¼šå–®ç­†é™¤éŒ¯æ¨¡å¼ ---
        async function runDebugMode() {
            if (!currentApiKey) return alert("è«‹å…ˆè¼‰å…¥è³‡æ–™");
            if (!geocoder) return alert("åœ°åœ–å…ƒä»¶æœªè¼‰å…¥");

            const btn = document.getElementById('btn-debug');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é™¤éŒ¯ä¸­...';

            try {
                // 1. å°‹æ‰¾ç›®æ¨™
                let target = allData.find(d => d[FIELDS.NAME] === CONFIG.TEST_NAME);
                let useAddress = CONFIG.TEST_ADDR;

                if (!target) {
                    log(`âš ï¸ æ‰¾ä¸åˆ°ã€Œ${CONFIG.TEST_NAME}ã€ï¼Œå˜—è©¦ä½¿ç”¨åˆ—è¡¨ç¬¬ä¸€ç­†åšæ¸¬è©¦`, "warn");
                    if (allData.length > 0) {
                        target = allData[0];
                        useAddress = target[FIELDS.ADDR]; // ä½¿ç”¨è©²ç­†è³‡æ–™çš„çœŸå¯¦åœ°å€
                        log(`ğŸ‘‰ æ”¹ç”¨ ID: ${target._ragicId} / åœ°å€: ${useAddress}`, "info");
                    } else {
                        throw new Error("æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä¾›æ¸¬è©¦");
                    }
                } else {
                    log(`ğŸ¯ é–å®šç›®æ¨™ ID: ${target._ragicId}`, "info");
                    // å¼·åˆ¶ä½¿ç”¨ä½¿ç”¨è€…æŒ‡å®šçš„æ¸¬è©¦åœ°å€ï¼Œæˆ–ä½¿ç”¨è³‡æ–™åº«å…§çš„åœ°å€
                    useAddress = CONFIG.TEST_ADDR; 
                    log(`ğŸ“ æº–å‚™ Geocoding: ${useAddress}`, "info");
                }

                // 2. åŸ·è¡Œ Geocoding
                const loc = await geocodeAddress(useAddress);
                const coordsVal = `${loc.lat()}, ${loc.lng()}`; // æ³¨æ„ï¼šåŠ äº†ç©ºæ ¼
                log(`âœ… Google æŸ¥è©¢æˆåŠŸ: ${coordsVal}`, "info");

                // 3. å˜—è©¦å¯«å…¥ (Form Post)
                log(`ğŸ’¾ æ­£åœ¨å˜—è©¦å¯«å…¥ Ragic...`, "warn");
                postToRagic(target._ragicId, coordsVal);

                // 4. æä¾› CURL é™¤éŒ¯æŒ‡ä»¤
                const server = document.getElementById('server-select').value;
                const url = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}/${target._ragicId}?api&APIKey=${currentApiKey}`;
                const data = `${FIELDS.COORDS}=${coordsVal}`;
                
                logCurl(url, data);

                alert("æ¸¬è©¦æŒ‡ä»¤å·²ç™¼é€ï¼\nè«‹è§€å¯Ÿ Log è¦–çª—ã€‚\nå¦‚æœ Ragic è³‡æ–™æ²’è®Šï¼Œè«‹è¤‡è£½ Log ä¸­çš„ curl æŒ‡ä»¤å»çµ‚ç«¯æ©ŸåŸ·è¡Œï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºæ¬Šé™éŒ¯èª¤ã€‚");

            } catch (e) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${e}`, "err");
                if (e === 'OVER_QUERY_LIMIT') alert("Google API é¡åº¦å·²æ»¿");
                else alert("ç™¼ç”ŸéŒ¯èª¤: " + e);
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-microscope"></i> åŸ·è¡Œå–®ç­†é™¤éŒ¯ (Debug)';
        }

        // Helper: Geocode Promise
        function geocodeAddress(addr) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address: addr }, (res, status) => {
                    if (status === 'OK') resolve(res[0].geometry.location);
                    else reject(status);
                });
            });
        }

        // Helper: Post Form
        function postToRagic(id, coordsVal) {
            const server = document.getElementById('server-select').value;
            const baseUrl = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}`;
            
            const form = document.getElementById('ragic_form');
            form.innerHTML = '';
            // å¯«å…¥æ™‚åªéœ€è¦ api èˆ‡ Key
            form.action = `${baseUrl}/${id}?api&APIKey=${encodeURIComponent(currentApiKey)}`;
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = FIELDS.COORDS; 
            input.value = coordsVal;
            form.appendChild(input);
            
            form.submit();
        }

        // Boot
        (function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.MAP_KEY}&callback=initMap&language=zh-TW`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        })();

    </script>
</body>
</html>
