<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Map v15.0 Sniper Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; height: 100vh; display: flex; flex-direction: column; font-family: 'Microsoft JhengHei', sans-serif; background: #f1f5f9; }
        #app { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 450px; background: #fff; display: flex; flex-direction: column; border-right: 1px solid #cbd5e1; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        #sidebar-header { padding: 12px; background: #0f172a; color: white; }
        #project-list { flex: 1; overflow-y: auto; background: #f8fafc; padding: 10px; }
        
        /* Map */
        #map { flex: 1; background: #e2e8f0; position: relative; }
        
        /* Components */
        .card { 
            background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid #cbd5e1;
            transition: all 0.2s; position: relative;
        }
        
        .action-btn { 
            width: 100%; border: none; padding: 8px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; margin-top: 5px; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: background 0.2s;
        }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        
        /* Debug Specific */
        .btn-debug { 
            background: #b91c1c; color: white; border: 1px solid #fca5a5;
            animation: pulse 2s infinite; padding: 12px; font-size: 14px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .api-input {
            width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid #475569; 
            background: #334155; color: white; font-size: 12px; margin-bottom: 4px;
        }
        .api-input:focus { outline: 2px solid #60a5fa; border-color: transparent; }
        
        .log-window {
            background: #0f172a; color: #4ade80; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px;
            height: 250px; overflow-y: auto; border-top: 4px solid #f59e0b;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 4px; word-break: break-all; }
        .curl-box {
            background: #334155; color: #e2e8f0; padding: 8px; margin: 4px 0; border-radius: 4px;
            font-size: 11px; user-select: all; word-break: break-all; border: 1px dashed #64748b; font-family: monospace;
        }
    </style>
</head>
<body>

    <!-- æ ¸å¿ƒæŠ€è¡“ï¼šéš±è— iframe å‚™ç”¨å¯«å…¥æ–¹æ¡ˆ -->
    <iframe name="hidden_iframe" style="display:none;"></iframe>
    <form id="ragic_form" target="hidden_iframe" method="POST" style="display:none;"></form>

    <div id="app">
        <!-- Sidebar -->
        <div id="sidebar">
            <div id="sidebar-header">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-crosshairs text-red-400"></i> v15 å–®ç­†ç‹™æ“Šç‰ˆ
                    </h1>
                    <span class="text-[10px] bg-red-900 px-2 py-1 rounded text-red-200">å®‰å…¨é™¤éŒ¯æ¨¡å¼</span>
                </div>
                
                <!-- Main Config -->
                <div>
                    <input type="password" id="api-key" class="api-input" placeholder="è²¼ä¸Š Ragic API Key">
                    <div class="flex gap-2">
                        <select id="server-select" class="api-input w-1/3 py-1">
                            <option value="ap14">ap14</option>
                            <option value="ap13">ap13</option>
                        </select>
                        <button onclick="loadData()" class="action-btn btn-blue mt-0 py-1 relative">
                            <i class="fas fa-sync-alt"></i> è¼‰å…¥è³‡æ–™
                        </button>
                    </div>
                </div>

                <!-- ç‹™æ“Šç›®æ¨™é¢æ¿ -->
                <div id="sniper-panel" class="hidden mt-4 pt-4 border-t border-slate-600">
                    <div class="bg-slate-800 p-3 rounded border border-slate-600">
                        <div class="text-xs text-yellow-400 font-bold mb-2">
                            <i class="fas fa-bullseye"></i> ç‹™æ“Šç›®æ¨™é–å®šï¼š
                        </div>
                        <div class="text-[11px] text-slate-300 space-y-1">
                            <div>åç¨±ï¼š<span class="text-white font-bold">å€å¡Šè­‰-é¾œå±±ç¾å…‰æ¡ˆ</span></div>
                            <div>åœ°å€ï¼š<span class="text-white">æ¡ƒåœ’å¸‚é¾œå±±å€å¾©èˆˆä¸‰è·¯667è™Ÿ</span></div>
                            <div>å¯«å…¥æ¬„ä½ï¼š<span class="text-red-400 font-bold">1000417</span> (å¼·åˆ¶æŒ‡å®š)</div>
                        </div>
                    </div>
                    
                    <button onclick="runSniperTest()" id="btn-sniper" class="action-btn btn-debug mt-3">
                        <i class="fas fa-fire"></i> åŸ·è¡Œå–®ç­†å¯«å…¥æ¸¬è©¦ (Fire)
                    </button>
                    <div class="text-[10px] text-gray-400 mt-2 text-center">
                        <i class="fas fa-shield-alt"></i> åƒ…æ¶ˆè€— 1 æ¬¡ Geocoding é¡åº¦
                    </div>
                </div>
            </div>

            <!-- List Placeholder -->
            <div id="project-list" class="h-20 flex flex-col items-center justify-center text-gray-400 text-sm bg-slate-50 border-b">
                <span>è«‹è¼¸å…¥ Key è¼‰å…¥è³‡æ–™...</span>
            </div>

            <!-- Log Window (Enlarged for debugging) -->
            <div id="log-window" class="log-window hidden flex-1">
                <div class="text-yellow-400 border-b border-gray-700 pb-1 mb-2 flex justify-between sticky top-0 bg-[#0f172a] z-10">
                    <span class="font-bold">> ç³»çµ±æ—¥èªŒ (System Log)</span>
                    <span class="text-[10px] cursor-pointer hover:text-white bg-slate-700 px-2 rounded" onclick="document.getElementById('log-window').innerHTML=''">æ¸…é™¤</span>
                </div>
                <!-- Logs will appear here -->
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>
    </div>

    <script>
        // --- å¯«æ­»çš„å®‰å…¨è¨­å®š (Hardcoded for Safety) ---
        const CONFIG = {
            RAGIC_PATH: "ChuckChargingCC/ragicproject-management/7",
            MAP_KEY: "AIzaSyDIYt9AZImHlL7xpb-30cyYOuAXsFufufw",
            TARGET_NAME: "å€å¡Šè­‰-é¾œå±±ç¾å…‰æ¡ˆ",
            TARGET_ADDR: "æ¡ƒåœ’å¸‚é¾œå±±å€å¾©èˆˆä¸‰è·¯667è™Ÿ",
            TARGET_FIELD: "1000417" // å¼·åˆ¶å¯«å…¥çš„æ¬„ä½ ID
        };
        
        // è®€å–ç”¨æ¬„ä½ (ç”¨æ–¼åœ¨æ¸…å–®ä¸­æ‰¾åˆ°ç›®æ¨™)
        let READ_FIELDS = { NAME: "1000167", ADDR: "1000190" };

        let map, geocoder, allData = [], currentApiKey = "";

        function log(msg, type='info') {
            const win = document.getElementById('log-window');
            win.classList.remove('hidden');
            const color = type === 'err' ? '#f87171' : type === 'warn' ? '#facc15' : type === 'success' ? '#4ade80' : '#60a5fa';
            const time = new Date().toLocaleTimeString('zh-TW', {hour12:false});
            win.innerHTML += `<div class="log-entry" style="color:${color}">[${time}] ${msg}</div>`;
            win.scrollTop = win.scrollHeight;
        }

        function initMap() {
            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 23.6, lng: 120.9 }, zoom: 8, mapTypeControl: false
                });
                geocoder = new google.maps.Geocoder();
                log("ğŸ—ºï¸ Google Maps API è¼‰å…¥å®Œæˆ", "info");
            } catch (e) { log("âŒ åœ°åœ–è¼‰å…¥å¤±æ•—: " + e.message, "err"); }
        }

        // --- Data Loading ---
        function loadData() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) return alert("è«‹è¼¸å…¥ Ragic API Key");
            currentApiKey = key;

            const server = document.getElementById('server-select').value;
            const url = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}?api&naming=EID&APIKey=${encodeURIComponent(key)}&callback=ragicCallback`;

            log(`ğŸ“¡ æ­£åœ¨é€£ç·šè®€å–è³‡æ–™ (${server})...`, "info");
            
            window.ragicCallback = function(res) {
                if (!res || res.status === 'ERROR') {
                    log(`âŒ API è®€å–éŒ¯èª¤: ${res?.msg || 'æœªçŸ¥'}`, "err");
                    return;
                }
                
                allData = Object.values(res);
                log(`âœ… æˆåŠŸè®€å– ${allData.length} ç­†è³‡æ–™`, "success");

                // æª¢æŸ¥æ¸¬è©¦è³‡æ–™æ˜¯å¦å­˜åœ¨
                const testExist = allData.find(d => d[READ_FIELDS.NAME] === CONFIG.TARGET_NAME);
                if (testExist) {
                    log(`ğŸ¯ å°‹ç²ç›®æ¨™æ¡ˆä»¶ï¼Œå…§éƒ¨ Record ID: ${testExist._ragicId}`, "success");
                    // ä¿®æ­£ï¼šæŒ‡å‘æ­£ç¢ºçš„é¢æ¿ ID 'sniper-panel'
                    document.getElementById('sniper-panel').classList.remove('hidden');
                    document.getElementById('project-list').innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-green-600 font-bold bg-green-50">
                            <i class="fas fa-check-circle mb-1 text-xl"></i> ç›®æ¨™é–å®šå®Œæˆï¼Œè«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•æ¸¬è©¦
                        </div>
                    `;
                } else {
                    log(`âš ï¸ åš´é‡éŒ¯èª¤ï¼šåœ¨ Ragic æ‰¾ä¸åˆ°åç‚ºã€Œ${CONFIG.TARGET_NAME}ã€çš„æ¡ˆä»¶ã€‚è«‹ç¢ºèªåç¨±æ˜¯å¦å®Œå…¨ä¸€è‡´ã€‚`, "err");
                    document.getElementById('project-list').innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-red-500 font-bold bg-red-50 p-2 text-center">
                            <i class="fas fa-times-circle mb-1 text-xl"></i> æ‰¾ä¸åˆ°æ¸¬è©¦è³‡æ–™<br>è«‹åœ¨ Ragic ç¢ºèªåç¨±ç‚ºã€Œ${CONFIG.TARGET_NAME}ã€
                        </div>
                    `;
                }
            };

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => log("âŒ é€£ç·šä¸­æ–· (Network Error)", "err");
            document.body.appendChild(script);
        }

        // --- æ ¸å¿ƒï¼šå–®ç­†ç‹™æ“Šæ¸¬è©¦ (Sniper Test) ---
        async function runSniperTest() {
            if (!geocoder) return alert("åœ°åœ–å…ƒä»¶æœªè¼‰å…¥");

            const btn = document.getElementById('btn-sniper');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ¸¬è©¦åŸ·è¡Œä¸­...';

            try {
                // 1. æŠ“å– Record ID
                const target = allData.find(d => d[READ_FIELDS.NAME] === CONFIG.TARGET_NAME);
                if (!target) throw new Error("æ‰¾ä¸åˆ°æ¸¬è©¦ç›®æ¨™");
                const recordId = target._ragicId;

                log(`==================================`, "warn");
                log(`ğŸš€ é–‹å§‹åŸ·è¡Œå–®ç­†æ¸¬è©¦`, "warn");

                // 2. åŸ·è¡Œ Geocoding
                log(`1ï¸âƒ£ å‘ Google æŸ¥è©¢åœ°å€: ${CONFIG.TARGET_ADDR}`, "info");
                const loc = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: CONFIG.TARGET_ADDR }, (res, status) => {
                        if (status === 'OK') resolve(res[0].geometry.location);
                        else reject(status);
                    });
                });
                
                const coordsVal = `${loc.lat()}, ${loc.lng()}`;
                log(`âœ… Google æŸ¥è©¢æˆåŠŸ: ${coordsVal}`, "success");

                // 3. æº–å‚™ Ragic å¯«å…¥è³‡è¨Š
                const server = document.getElementById('server-select').value;
                const postUrl = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}/${recordId}?api&APIKey=${encodeURIComponent(currentApiKey)}`;
                
                log(`2ï¸âƒ£ æº–å‚™å¯«å…¥ Ragic æ¬„ä½ [${CONFIG.TARGET_FIELD}]...`, "info");

                // --- æ¸¬è©¦ A: Fetch API ç›´æ¥å¯«å…¥ (èƒ½æ•æ‰çœŸå¯¦éŒ¯èª¤è¨Šæ¯) ---
                log(`ğŸ‘‰ [æ¸¬è©¦ A] åŸ·è¡Œ Fetch API å¯«å…¥...`, "warn");
                try {
                    const params = new URLSearchParams();
                    params.append(CONFIG.TARGET_FIELD, coordsVal);

                    const response = await fetch(postUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params.toString()
                    });
                    
                    const resultJson = await response.json();
                    
                    if (resultJson.status === 'SUCCESS') {
                        log(`âœ… [æ¸¬è©¦ A æˆåŠŸ] Ragic å›å‚³æˆåŠŸï¼åº§æ¨™å·²å¯«å…¥ã€‚`, "success");
                    } else {
                        log(`âŒ [æ¸¬è©¦ A å¤±æ•—] Ragic æ‹’çµ•å¯«å…¥ã€‚`, "err");
                        log(`âš ï¸ Ragic å ±éŒ¯è¨Šæ¯: ${resultJson.msg}`, "err");
                        if (resultJson.msg && resultJson.msg.includes('access right protected')) {
                            log(`ğŸš¨ è¨ºæ–·çµæœ: æ‚¨çš„ API Key åªæœ‰ã€Œå”¯è®€ã€æ¬Šé™ï¼Œæ²’æœ‰é€™å¼µè¡¨å–®çš„ã€Œä¿®æ”¹ã€æ¬Šé™ï¼`, "err");
                            log(`ğŸ’¡ è§£æ³•: è«‹è‡³ Ragic è¡¨å–®è¨­è¨ˆæ¨¡å¼ -> è¡¨å–®æ¬Šé™ -> ç¢ºèªæ‚¨çš„ç¾¤çµ„å…·æœ‰ä¿®æ”¹æ¬Šé™ã€‚`, "info");
                        }
                    }
                } catch (fetchErr) {
                    log(`âŒ [æ¸¬è©¦ A å¤±æ•—] ç€è¦½å™¨æ””æˆª (CORS è·¨åŸŸé˜»æ“‹)`, "err");
                    log(`å› ç‚ºç™¼ç”Ÿ CORSï¼Œæˆ‘å€‘æ”¹ç”¨ [æ¸¬è©¦ B] Iframe é€²è¡Œç›²å¯«...`, "warn");
                    
                    // --- æ¸¬è©¦ B: Iframe éš±è—è¡¨å–®å¯«å…¥ (ç¹é CORSï¼Œä½†çœ‹ä¸åˆ°å ±éŒ¯) ---
                    const form = document.getElementById('ragic_form');
                    form.innerHTML = '';
                    form.action = postUrl;
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = CONFIG.TARGET_FIELD; 
                    input.value = coordsVal;
                    form.appendChild(input);
                    form.submit();
                    
                    log(`âœ… [æ¸¬è©¦ B é€å‡º] Iframe è¡¨å–®å·²é€å‡ºã€‚`, "success");
                    log(`ğŸ’¡ ç”±æ–¼æ˜¯ç›²å¯«ï¼Œè«‹ç›´æ¥å» Ragic ç¶²é æŸ¥çœ‹ã€Œ${CONFIG.TARGET_NAME}ã€çš„åº§æ¨™æ¬„ä½ (${CONFIG.TARGET_FIELD}) æ˜¯å¦æœ‰å‡ºç¾æ•¸å­—ã€‚`, "info");
                }

                // --- æ¸¬è©¦ C: ç”¢å‡º CURL æŒ‡ä»¤ (çµ‚æ¥µé˜²ç·š) ---
                log(`3ï¸âƒ£ ç”¢ç”Ÿ cURL çµ‚ç«¯æ©ŸæŒ‡ä»¤ (ä¾›æ‰‹å‹•æ¸¬è©¦)ï¼š`, "info");
                const curlCmd = `curl -X POST "https://${server}.ragic.com/${CONFIG.RAGIC_PATH}/${recordId}?api&APIKey=${currentApiKey}" \\\n-d "${CONFIG.TARGET_FIELD}=${coordsVal}"`;
                
                const win = document.getElementById('log-window');
                win.innerHTML += `<div class="curl-box">${curlCmd}</div>`;
                win.scrollTop = win.scrollHeight;

                log(`==================================`, "warn");

            } catch (e) {
                log(`âŒ ç™¼ç”Ÿç•°å¸¸éŒ¯èª¤: ${e}`, "err");
                if (e === 'ZERO_RESULTS') alert("Google æ‰¾ä¸åˆ°æ­¤åœ°å€ã€‚");
                else if (e === 'OVER_QUERY_LIMIT') alert("Google API é¡åº¦å·²æ»¿ã€‚");
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-fire"></i> åŸ·è¡Œå–®ç­†å¯«å…¥æ¸¬è©¦ (Fire)';
        }

        // Boot
        (function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.MAP_KEY}&callback=initMap&language=zh-TW`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        })();

    </script>
</body>
</html>
