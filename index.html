<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Map v13.0 Filtered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; height: 100vh; display: flex; flex-direction: column; font-family: 'Microsoft JhengHei', sans-serif; background: #f1f5f9; }
        #app { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 420px; background: #fff; display: flex; flex-direction: column; border-right: 1px solid #cbd5e1; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        #sidebar-header { padding: 12px; background: #0f172a; color: white; }
        #project-list { flex: 1; overflow-y: auto; background: #f8fafc; padding: 10px; }
        
        /* Map */
        #map { flex: 1; background: #e2e8f0; position: relative; }
        
        /* Components */
        .card { 
            background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid #cbd5e1;
            transition: all 0.2s; position: relative;
        }
        .card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .action-btn { 
            width: 100%; border: none; padding: 8px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; margin-top: 5px; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: background 0.2s;
        }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        
        .btn-red { background: #ef4444; color: white; }
        .btn-red:hover { background: #dc2626; }
        .btn-red:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }

        .api-input {
            width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid #475569; 
            background: #334155; color: white; font-size: 12px; margin-bottom: 4px;
        }
        .api-input:focus { outline: 2px solid #60a5fa; border-color: transparent; }

        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
        .config-label { font-size: 10px; color: #94a3b8; }
        
        .fix-mini-btn {
            position: absolute; right: 10px; top: 10px;
            background: #ef4444; color: white; font-size: 11px; padding: 4px 8px; 
            border-radius: 20px; cursor: pointer; border: none; font-weight: bold;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            z-index: 5;
        }
        .fix-mini-btn:hover { background: #dc2626; }
        .fix-mini-btn i { margin-right: 3px; }

        .log-window {
            background: #0f172a; color: #4ade80; padding: 8px; font-family: monospace; font-size: 11px;
            height: 120px; overflow-y: auto; border-top: 4px solid #f59e0b;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; word-break: break-all; }
        
        .filter-badge {
            background: #eab308; color: black; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; display: none;
        }
    </style>
</head>
<body>

    <!-- æ ¸å¿ƒæŠ€è¡“ï¼šéš±è— iframe ç”¨æ–¼è·¨åŸŸå¯«å…¥ -->
    <iframe name="hidden_iframe" style="display:none;"></iframe>
    <form id="ragic_form" target="hidden_iframe" method="POST" style="display:none;"></form>

    <div id="app">
        <!-- Sidebar -->
        <div id="sidebar">
            <div id="sidebar-header">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-filter text-yellow-400"></i> å·¥ç¨‹å¯¦ç¸¾åœ°åœ– v13
                    </h1>
                    <span class="text-[10px] bg-slate-700 px-2 py-1 rounded text-slate-300">ç²¾æº–é™¤éŒ¯ç‰ˆ</span>
                </div>
                
                <!-- Main Config -->
                <div>
                    <input type="password" id="api-key" class="api-input" placeholder="è²¼ä¸Š Ragic API Key">
                    <div class="flex gap-2">
                        <select id="server-select" class="api-input w-1/3 py-1">
                            <option value="ap14">ap14</option>
                            <option value="ap13">ap13</option>
                        </select>
                        <button onclick="loadData()" class="action-btn btn-blue mt-0 py-1 relative">
                            <i class="fas fa-sync-alt"></i> è¼‰å…¥è³‡æ–™
                        </button>
                    </div>
                </div>

                <!-- Field Settings (å¯æŠ˜ç–Š) -->
                <div class="mt-2 pt-2 border-t border-slate-600">
                    <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('field-config').classList.toggle('hidden')">
                        <span class="text-xs text-slate-300 font-bold"><i class="fas fa-cog"></i> æ¬„ä½ ID è¨­å®š</span>
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                    <div id="field-config" class="hidden">
                        <div class="config-grid">
                            <div><div class="config-label">åç¨± ID</div><input id="fid-name" class="api-input" value="1000167"></div>
                            <div><div class="config-label">é¡åˆ¥ ID</div><input id="fid-cat" class="api-input" value="1000372"></div>
                            <div><div class="config-label">åœ°å€ ID</div><input id="fid-addr" class="api-input" value="1000190"></div>
                            <div><div class="config-label">åº§æ¨™ ID</div><input id="fid-coords" class="api-input" value="1000417"></div>
                        </div>
                        <button onclick="applyFields()" class="w-full bg-slate-600 hover:bg-slate-500 text-white text-[10px] py-1 rounded mt-1">æ›´æ–°è¨­å®šä¸¦é‡ç¹ª</button>
                    </div>
                </div>

                <!-- Batch Tools -->
                <div id="tools-panel" class="hidden mt-2">
                    <button onclick="startAutoFix()" id="btn-fix" class="action-btn btn-red" disabled>
                        <i class="fas fa-magic"></i> æ‰¹é‡ä¿®å¾© (<span id="fix-count">0</span>)
                    </button>
                    <div class="text-[10px] text-gray-400 mt-1 text-center">
                        <i class="fas fa-info-circle"></i> è«‹åœ¨ GitHub Pages æˆ–æœ¬æ©ŸåŸ·è¡Œä»¥ç¢ºä¿å¯«å…¥åŠŸèƒ½æ­£å¸¸
                    </div>
                </div>
            </div>

            <div id="project-list">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 text-sm">
                    <i class="fas fa-arrow-up mb-2 text-2xl animate-bounce"></i>
                    <span>è«‹è¼¸å…¥ Key ä¸¦è¼‰å…¥è³‡æ–™</span>
                </div>
            </div>

            <div id="log-window" class="log-window hidden">
                <div class="text-yellow-400 border-b border-gray-700 pb-1 mb-1">> ç³»çµ±æ—¥èªŒ</div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>
    </div>

    <script>
        // --- Global State ---
        let CONFIG = {
            RAGIC_PATH: "ChuckChargingCC/ragicproject-management/7",
            MAP_KEY: "AIzaSyDIYt9AZImHlL7xpb-30cyYOuAXsFufufw"
        };
        
        // ç•¶å‰ä½¿ç”¨çš„ Field IDs
        let FIELDS = {
            NAME: "1000167", CAT: "1000372", ADDR: "1000190", COORDS: "1000417"
        };

        let map, geocoder, allData = [], markers = [], currentApiKey = "";
        
        const COLORS = { "default": "#64748b", "å®¶ç”¨": "#3b82f6", "å•†ç”¨": "#10b981", "å…¬å…±": "#f59e0b", "å¿«å……": "#ef4444" };

        function log(msg, type='info') {
            const win = document.getElementById('log-window');
            win.classList.remove('hidden');
            const color = type === 'err' ? '#f87171' : type === 'warn' ? '#facc15' : '#4ade80';
            const time = new Date().toLocaleTimeString('zh-TW', {hour12:false});
            win.innerHTML += `<div class="log-entry" style="color:${color}">[${time}] ${msg}</div>`;
            win.scrollTop = win.scrollHeight;
        }

        function initMap() {
            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 23.6, lng: 120.9 }, zoom: 8, mapTypeControl: false
                });
                geocoder = new google.maps.Geocoder();
                log("Google Maps API è¼‰å…¥æˆåŠŸ");
            } catch (e) { log("åœ°åœ–è¼‰å…¥å¤±æ•—: " + e.message, "err"); }
        }

        // --- Data Loading ---
        function loadData() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) return alert("è«‹è¼¸å…¥ Ragic API Key");
            currentApiKey = key;

            // è®€å– UI ä¸Šçš„è¨­å®š
            FIELDS.NAME = document.getElementById('fid-name').value;
            FIELDS.CAT = document.getElementById('fid-cat').value;
            FIELDS.ADDR = document.getElementById('fid-addr').value;
            FIELDS.COORDS = document.getElementById('fid-coords').value;

            const server = document.getElementById('server-select').value;
            const url = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}?api&naming=EID&APIKey=${encodeURIComponent(key)}&callback=ragicCallback`;

            log(`é€£ç·šä¸­ (${server})...`, "info");
            
            window.ragicCallback = function(res) {
                if (!res || res.status === 'ERROR') {
                    log(`API éŒ¯èª¤: ${res?.msg || 'æœªçŸ¥'}`, "err");
                    return alert("è®€å–å¤±æ•—ï¼è«‹æª¢æŸ¥ Key æˆ–åˆ‡æ›ä¼ºæœå™¨ã€‚");
                }
                
                let data = Object.values(res);
                const originalCount = data.length;

                // === CTO Filter Logic: éæ¿¾ç„¡åœ°å€è³‡æ–™ ===
                data = data.filter(item => {
                    const addr = item[FIELDS.ADDR];
                    // ç¢ºä¿åœ°å€å­˜åœ¨ã€æ˜¯å­—ä¸²ã€ä¸”ä¸æ˜¯ç©ºå­—ä¸²
                    return addr && typeof addr === 'string' && addr.trim().length > 0;
                });
                
                const filteredCount = originalCount - data.length;
                
                log(`è®€å–: ${originalCount} ç­†`, "info");
                if (filteredCount > 0) {
                    log(`å·²è‡ªå‹•éš±è— ${filteredCount} ç­†ã€Œç„¡åœ°å€ã€è³‡æ–™`, "warn");
                }
                log(`å¯¦éš›é¡¯ç¤º: ${data.length} ç­†`, "info");

                allData = data;
                
                // æ™ºèƒ½åµæ¸¬ (å¦‚æœéæ¿¾å¾Œé‚„æœ‰è³‡æ–™)
                if (data.length > 0) detectFieldIds(data[0]);

                renderUI();
            };

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => log("é€£ç·šä¸­æ–· (Network Error)", "err");
            document.body.appendChild(script);
        }

        // --- Field Detection ---
        function detectFieldIds(record) {
            // å¦‚æœç•¶å‰è¨­å®šçš„åœ°å€ ID è®€ä¸åˆ°æ±è¥¿ï¼Œå˜—è©¦è‡ªå‹•å°‹æ‰¾
            const currentAddrVal = record[FIELDS.ADDR];
            if (!currentAddrVal) {
                log("âš ï¸ ç•¶å‰åœ°å€ ID è®€å–ç‚ºç©ºï¼Œå˜—è©¦è‡ªå‹•æœå°‹...", "warn");
                Object.keys(record).forEach(k => {
                    const v = String(record[k]);
                    if (v.includes('å¸‚') && v.includes('å€') && v.length > 5) {
                        log(`ğŸ’¡ ç™¼ç¾ç–‘ä¼¼åœ°å€æ¬„ä½: ${k} (${v.substring(0,8)}...)`, "warn");
                        // æ›´æ–° UI
                        document.getElementById('fid-addr').value = k;
                        FIELDS.ADDR = k;
                        log("å·²è‡ªå‹•æ›´æ–°åœ°å€æ¬„ä½è¨­å®š", "info");
                    }
                });
            }
        }

        function applyFields() {
            FIELDS.NAME = document.getElementById('fid-name').value;
            FIELDS.CAT = document.getElementById('fid-cat').value;
            FIELDS.ADDR = document.getElementById('fid-addr').value;
            FIELDS.COORDS = document.getElementById('fid-coords').value;
            // é‡æ–°è¼‰å…¥ä»¥è§¸ç™¼éæ¿¾
            if (currentApiKey) loadData();
        }

        // --- Render ---
        function renderUI() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            markers.forEach(m => m.setMap(null));
            markers = [];

            let fixCount = 0;
            const bounds = new google.maps.LatLngBounds();

            if (allData.length === 0) {
                 list.innerHTML = '<div class="text-center p-5 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
                 return;
            }

            allData.forEach(item => {
                const id = item._ragicId;
                const name = item[FIELDS.NAME] || '(ç„¡åç¨±)';
                const addr = item[FIELDS.ADDR];
                const coords = item[FIELDS.COORDS];
                const cat = item[FIELDS.CAT] || 'default';
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦ä¿®å¾©
                const hasValidCoords = coords && coords.includes(',') && !isNaN(parseFloat(coords.split(',')[0]));
                const needsFix = !hasValidCoords; // å› ç‚ºæˆ‘å€‘å·²ç¶“éæ¿¾æ‰ç„¡åœ°å€çš„ï¼Œæ‰€ä»¥å‰©ä¸‹çš„åªè¦æ²’åº§æ¨™å°±æ˜¯å¾…ä¿®å¾©
                
                if (needsFix) fixCount++;

                // å»ºç«‹å¡ç‰‡
                const card = document.createElement('div');
                card.className = 'card';
                const color = COLORS[cat] || COLORS['default'];
                card.style.borderLeftColor = color;
                
                let btnHtml = '';
                if (needsFix) {
                    // å–®ç­†ä¿®å¾©æŒ‰éˆ•
                    btnHtml = `<button onclick="fixSingleItem('${id}', '${addr}')" class="fix-mini-btn" title="å¼·åˆ¶ä¿®å¾©æ­¤ç­†"><i class="fas fa-magic"></i> ä¿®å¾©</button>`;
                }

                card.innerHTML = `
                    ${btnHtml}
                    <div class="flex justify-between mt-1">
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded text-white" style="background:${color}">${cat}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 mt-1 text-sm">${name}</h3>
                    <p class="text-xs text-gray-500 mt-1 truncate"><i class="fas fa-map-marker-alt"></i> ${addr}</p>
                    <div class="mt-1 text-[10px] ${hasValidCoords ? 'text-green-600' : 'text-red-500'} font-bold">
                        ${hasValidCoords ? '<i class="fas fa-check"></i> å·²å®šä½' : '<i class="fas fa-times"></i> ç¼ºåº§æ¨™'}
                    </div>
                `;
                
                if (hasValidCoords) {
                    const [lat, lng] = coords.split(',').map(Number);
                    const marker = new google.maps.Marker({
                        position: {lat, lng}, map: map, title: name,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: '#fff' }
                    });
                    const clickFn = () => { map.panTo({lat, lng}); map.setZoom(16); };
                    marker.addListener('click', clickFn);
                    card.onclick = (e) => { if(e.target.tagName !== 'BUTTON') clickFn(); }; 
                    markers.push(marker);
                    bounds.extend({lat, lng});
                }
                
                list.appendChild(card);
            });

            if (markers.length > 0) map.fitBounds(bounds);

            // Update Batch Tools
            document.getElementById('tools-panel').classList.remove('hidden');
            document.getElementById('fix-count').innerText = fixCount;
            const btnFix = document.getElementById('btn-fix');
            if (fixCount > 0) {
                btnFix.disabled = false;
                btnFix.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnFix.disabled = true;
                btnFix.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Core: Fix Single Item ---
        async function fixSingleItem(id, addr) {
            if (!confirm(`ç¢ºå®šè¦ä¿®å¾©æ­¤æ¡ˆä»¶å—ï¼Ÿ\nåœ°å€: ${addr}`)) return;
            
            log(`æ­£åœ¨ä¿®å¾©å–®ç­†: ${addr}...`, "warn");
            
            try {
                // 1. Google Geocoding
                const loc = await geocodeAddress(addr);
                const coordsVal = `${loc.lat()}, ${loc.lng()}`;
                log(`-> å–å¾—åº§æ¨™: ${coordsVal}`, "info");

                // 2. Post to Ragic
                postToRagic(id, coordsVal);
                
                // 3. UI Feedback
                alert("ä¿®å¾©æŒ‡ä»¤å·²ç™¼é€ï¼\nè«‹ç­‰å¾…ç´„ 2 ç§’å¾Œï¼Œé‡æ–°è¼‰å…¥è³‡æ–™æŸ¥çœ‹çµæœã€‚");

            } catch (e) {
                log(`ä¿®å¾©å¤±æ•—: ${e}`, "err");
                if(e === 'ZERO_RESULTS') alert("Google æ‰¾ä¸åˆ°æ­¤åœ°å€ï¼Œè«‹ç¢ºèªåœ°å€æ˜¯å¦æ­£ç¢ºã€‚");
                else if(e === 'OVER_QUERY_LIMIT') alert("API é¡åº¦å·²æ»¿ï¼Œè«‹ä¼‘æ¯ä¸€ä¸‹ã€‚");
                else alert("ç™¼ç”ŸéŒ¯èª¤: " + e);
            }
        }

        // --- Core: Batch Fix ---
        async function startAutoFix() {
            // åªä¿®å¾©éæ¿¾å¾Œçš„è³‡æ–™ä¸­ï¼Œç¼ºåº§æ¨™çš„é …ç›®
            const targets = allData.filter(d => {
                const coords = d[FIELDS.COORDS];
                const hasValidCoords = coords && coords.includes(',') && !isNaN(parseFloat(coords.split(',')[0]));
                return !hasValidCoords;
            });

            if (targets.length === 0) return alert("æ²’æœ‰éœ€è¦ä¿®å¾©çš„è³‡æ–™");
            if (!confirm(`å³å°‡ä¿®å¾© ${targets.length} ç­†è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;

            const btn = document.getElementById('btn-fix');
            btn.disabled = true;

            for (let i = 0; i < targets.length; i++) {
                const item = targets[i];
                const id = item._ragicId;
                const addr = item[FIELDS.ADDR];

                log(`[æ‰¹é‡ ${i+1}/${targets.length}] è™•ç†: ${addr}`, "warn");

                try {
                    const loc = await geocodeAddress(addr);
                    const coordsVal = `${loc.lat()}, ${loc.lng()}`;
                    postToRagic(id, coordsVal);
                    log(`-> æˆåŠŸç™¼é€`, "info");
                } catch (e) {
                    log(`-> å¤±æ•—: ${e}`, "err");
                }
                
                await new Promise(r => setTimeout(r, 1200)); // é¿å…éå¿«
            }

            alert("æ‰¹é‡ä½œæ¥­çµæŸï¼è«‹é‡æ–°è¼‰å…¥è³‡æ–™ã€‚");
            btn.disabled = false;
            loadData();
        }

        // Helper: Geocode Promise
        function geocodeAddress(addr) {
            return new Promise((resolve, reject) => {
                if (!geocoder) return reject("Geocoding API æœªè¼‰å…¥");
                geocoder.geocode({ address: addr }, (res, status) => {
                    if (status === 'OK') resolve(res[0].geometry.location);
                    else reject(status);
                });
            });
        }

        // Helper: Post Form
        function postToRagic(id, coordsVal) {
            const server = document.getElementById('server-select').value;
            const baseUrl = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}`;
            
            const form = document.getElementById('ragic_form');
            form.innerHTML = '';
            form.action = `${baseUrl}/${id}?api&APIKey=${encodeURIComponent(currentApiKey)}`;
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = FIELDS.COORDS; 
            input.value = coordsVal;
            form.appendChild(input);
            
            form.submit();
        }

        // Boot
        (function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.MAP_KEY}&callback=initMap&language=zh-TW`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        })();

    </script>
</body>
</html>
