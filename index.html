<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Map v23.1 Cloud Fixed Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; height: 100vh; display: flex; flex-direction: column; font-family: 'Microsoft JhengHei', sans-serif; background: #f1f5f9; }
        #app { display: flex; flex: 1; overflow: hidden; }
        
        /* UI å„ªåŒ–ï¼šå·¦å´æ¬„ä½ç¸®å°è‡³ 300pxï¼Œæœ€å¤§åŒ–åœ°åœ–ç©ºé–“ */
        #sidebar { width: 300px; background: #fff; display: flex; flex-direction: column; border-right: 1px solid #cbd5e1; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        #sidebar-header { padding: 12px; background: #0f172a; color: white; }
        #project-list { flex: 1; overflow-y: auto; background: #f8fafc; padding: 8px; }
        
        /* Map */
        #map { flex: 1; background: #e2e8f0; position: relative; }
        
        /* Components */
        .card { 
            background: white; padding: 8px; margin-bottom: 6px; border-radius: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid #cbd5e1;
            transition: all 0.2s; position: relative;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .action-btn { 
            width: 100%; border: none; padding: 8px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; margin-top: 5px; font-size: 12px;
            display: flex; align-items: center; justify-content: center; gap: 4px;
            transition: background 0.2s;
        }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        .btn-green { background: #10b981; color: white; }
        .btn-green:hover { background: #059669; }
        .btn-green:disabled { background: #6ee7b7; cursor: not-allowed; }

        .api-input {
            width: 100%; padding: 4px 8px; border-radius: 4px; border: 1px solid #475569; 
            background: #334155; color: white; font-size: 11px; margin-bottom: 4px;
        }
        .api-input:focus { outline: 2px solid #60a5fa; border-color: transparent; }
        
        .log-window {
            background: #0f172a; color: #4ade80; padding: 8px; font-family: 'Courier New', monospace; font-size: 10px;
            height: 120px; overflow-y: auto; border-top: 4px solid #f59e0b;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; word-break: break-all; }
    </style>
</head>
<body>

    <div id="app">
        <!-- Sidebar -->
        <div id="sidebar">
            <div id="sidebar-header">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-base font-bold flex items-center gap-2">
                        <i class="fas fa-cloud text-blue-400"></i> v23.1 å®˜ç¶²é›²ç«¯ç‰ˆ
                    </h1>
                    <span class="text-[9px] bg-blue-900 px-2 py-1 rounded text-blue-200">å³æ™‚åŒæ­¥</span>
                </div>
                
                <!-- Main Config (å·²éš±è— API å¡«å¯«å€ï¼Œæ”¹ç‚ºå…¨è‡ªå‹•) -->
                <div>
                    <div class="hidden">
                        <input type="password" id="api-key" class="api-input" placeholder="è²¼ä¸Š Ragic API Key">
                        <select id="server-select" class="api-input w-1/3 py-1">
                            <option value="ap14">ap14</option>
                            <option value="ap13">ap13</option>
                        </select>
                    </div>
                    <button onclick="window.loadData()" class="action-btn btn-blue mt-0 py-1 relative" id="btn-load">
                        <i class="fas fa-sync-alt"></i> æ‰‹å‹•é‡æ–°è®€å–
                    </button>
                </div>

                <!-- éš±è—è¨­å®šå€ -->
                <div class="mt-2 pt-2 border-t border-slate-600">
                    <div class="flex justify-between items-center cursor-pointer mb-2" onclick="document.getElementById('field-config').classList.toggle('hidden')">
                        <span class="text-[11px] text-slate-300 font-bold"><i class="fas fa-cog"></i> æ¬„ä½è¨­å®š</span>
                        <i class="fas fa-chevron-down text-slate-400 text-[10px]"></i>
                    </div>
                    <div id="field-config" class="hidden grid grid-cols-2 gap-2 text-[10px] mb-2">
                        <div><div class="text-slate-400 mb-1">åç¨± ID</div><input id="fid-name" class="api-input" value="1000167"></div>
                        <div><div class="text-slate-400 mb-1">é¡åˆ¥ ID</div><input id="fid-cat" class="api-input" value="1000372"></div>
                        <div><div class="text-slate-400 mb-1">åœ°å€ ID</div><input id="fid-addr" class="api-input" value="1000190"></div>
                        <div><div class="text-slate-400 mb-1">åº§æ¨™ ID</div><input id="fid-coords" class="api-input" value="1000417"></div>
                    </div>
                </div>

                <!-- å‹•æ…‹ç”ŸæˆæŒ‰éˆ• & é›²ç«¯å¿«å–ç‹€æ…‹ -->
                <div id="render-panel" class="hidden mt-2">
                    <button onclick="window.startDynamicMapping()" id="btn-render" class="action-btn btn-green mt-0">
                        <i class="fas fa-satellite-dish"></i> 2. è§£ææ–°åœ°å€ä¸¦ä¸Šå‚³
                    </button>
                    
                    <div class="bg-slate-800 p-2 rounded border border-slate-700 flex justify-between items-center mt-2">
                        <div class="text-[11px] text-slate-300">
                            <i class="fas fa-database text-blue-400"></i> é›²ç«¯å¿«å–ï¼š<span id="cache-count" class="text-yellow-400 font-bold">0</span> ç­†
                        </div>
                        <div id="fb-status" class="text-[9px] text-yellow-500 font-bold">é€£ç·šä¸­...</div>
                    </div>
                </div>
            </div>

            <div id="project-list">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 text-sm text-center px-4">
                    <span>è¼‰å…¥ä¸­...<br><span class="text-[10px] mt-2 block text-gray-500">ç³»çµ±æ­£åœ¨è‡ªå‹•ç‚ºæ‚¨æŠ“å–æœ€æ–°è³‡æ–™</span></span>
                </div>
            </div>

            <div id="log-window" class="log-window">
                <div class="text-yellow-400 border-b border-gray-700 pb-1 mb-1 flex justify-between sticky top-0 bg-[#0f172a] z-10">
                    <span class="font-bold">> ç³»çµ±æ—¥èªŒ</span>
                    <span class="text-[9px] cursor-pointer hover:text-white bg-slate-700 px-2 rounded" onclick="window.clearLog()">æ¸…é™¤</span>
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- Firebase v11 & æ ¸å¿ƒé‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ğŸš€ å…¨è‡ªå‹•è¨­å®šå€
        // ==========================================
        const CONFIG = {
            RAGIC_PATH: "ChuckChargingCC/ragicproject-management/7",
            MAP_KEY: "AIzaSyDIYt9AZImHlL7xpb-30cyYOuAXsFufufw",
            PREFILL_RAGIC_KEY: "aE9KcVErZy9iTTJQWDJCeWZLaFM2RUtQRXd2bGxnS1lxYm9PN0pPc1J2bmRzRnN2blRzTE9JSHNyQmpnM1dPVA==" 
        };

        let FIELDS = { NAME: "1000167", CAT: "1000372", ADDR: "1000190", COORDS: "1000417" };
        let map, geocoder, allData = [], currentApiKey = "";
        let markers = [];
        let bounds;
        
        const COLORS = { "å°ˆæ¡ˆ": "#f97316", "å®¶å……": "#3b82f6", "ç¤¾å€": "#10b981", "default": "#64748b" };

        let db, auth, currentUser;
        let cloudCache = {}; 
        
        // --- Firebase åˆå§‹åŒ– (æ”¯æ´ç’°å¢ƒæ™ºèƒ½åˆ‡æ›) ---
        const initFirebase = async () => {
            try {
                let firebaseConfig;
                let isPreviewEnv = false;
                
                // 1. åˆ¤æ–·æ˜¯å¦åœ¨ Gemini é è¦½ç’°å¢ƒ (Canvas)
                if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config !== '{}') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    isPreviewEnv = true;
                    log(`â„¹ï¸ åµæ¸¬åˆ°é è¦½ç’°å¢ƒï¼Œä½¿ç”¨ç³»çµ±å…§å»ºè³‡æ–™åº«`, 'info');
                } else {
                    // 2. å¦‚æœæ”¾åœ¨æ‚¨çš„å®˜ç¶²ï¼Œå‰‡ä½¿ç”¨æ‚¨çš„å°ˆå±¬è³‡æ–™åº«
                    firebaseConfig = {
                        apiKey: "AIzaSyCGqiHwPv2ero7SVmqN5gkyfqDh5o2AEjo",
                        authDomain: "ev-map-1470c.firebaseapp.com",
                        projectId: "ev-map-1470c",
                        storageBucket: "ev-map-1470c.firebasestorage.app",
                        messagingSenderId: "314662873363",
                        appId: "1:314662873363:web:d2124b85c423ab2bf7d2e6",
                        measurementId: "G-3PJP8NJGEB"
                    };
                    log(`â„¹ï¸ åµæ¸¬åˆ°æ­£å¼ç’°å¢ƒï¼Œé€£ç·šè‡³ ev-map-1470c`, 'info');
                }
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // æ ¹æ“šç’°å¢ƒé¸æ“‡å®‰å…¨çš„ç™»å…¥æ–¹å¼
                if (isPreviewEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    const statusEl = document.getElementById('fb-status');
                    if (user) {
                        statusEl.innerText = "å·²é€£ç·š";
                        statusEl.className = "text-[9px] text-green-400 font-bold";
                        setupFirestoreListener(isPreviewEnv);
                        
                        // å…¨è‡ªå‹•è§¸ç™¼ï¼šé€£ç·šæˆåŠŸå¾Œè‡ªå‹•è®€å–è³‡æ–™
                        setTimeout(() => { window.loadData(); }, 1500);
                    } else {
                        statusEl.innerText = "æœªç™»å…¥";
                        statusEl.className = "text-[9px] text-red-400 font-bold";
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                const statusEl = document.getElementById('fb-status');
                
                // é‡å°ã€Œæœªé–‹å•ŸåŒ¿åç™»å…¥ã€çš„ç²¾æº–å ±éŒ¯æç¤º
                if (e.code === 'auth/configuration-not-found' || e.code === 'auth/admin-restricted-operation') {
                    log(`ğŸ”¥ Firebase æ¬Šé™éŒ¯èª¤ï¼šæ‚¨å°šæœªé–‹å•ŸåŒ¿åç™»å…¥ï¼`, 'err');
                    log(`ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼šè«‹å‰å¾€ Firebase å¾Œå° -> Authentication (é©—è­‰) -> Sign-in methodï¼Œå°‡ã€ŒåŒ¿å (Anonymous)ã€è¨­ç‚ºå•Ÿç”¨ã€‚`, 'err');
                    if (statusEl) { statusEl.innerText = "æ¬Šé™é­æ‹’"; statusEl.className = "text-[9px] text-red-400 font-bold"; }
                } else {
                    log(`ğŸ”¥ Firebase åˆå§‹åŒ–å¤±æ•—: ${e.message}`, 'err');
                    if (statusEl) { statusEl.innerText = "é€£ç·šå¤±æ•—"; statusEl.className = "text-[9px] text-red-400 font-bold"; }
                }
                
                // âš ï¸ é˜²å‘†æ©Ÿåˆ¶ï¼šå³ä½¿ Firebase ç•°å¸¸ï¼Œä»ç„¶å¼·åˆ¶è¼‰å…¥ Ragic åœ°åœ–
                log(`ğŸ”„ å•Ÿå‹•é˜²å‘†æ©Ÿåˆ¶ï¼Œå¼·åˆ¶è¼‰å…¥åœ°åœ–è³‡æ–™...`, 'warn');
                setTimeout(() => { window.loadData(); }, 1000);
            }
        };

        // --- ç›£è½ Firestore å¿«å–è®Šæ›´ ---
        const setupFirestoreListener = (isPreviewEnv) => {
            if (!currentUser) return;
            
            // ç¢ºä¿è·¯å¾‘è®Šæ•¸æ­£ç¢º
            const currentAppId = typeof __app_id !== 'undefined' && isPreviewEnv ? __app_id : 'ev-map-production';
            const cacheRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'coords_cache');
            
            onSnapshot(cacheRef, (snapshot) => {
                cloudCache = {}; 
                snapshot.forEach(docSnap => {
                    cloudCache[docSnap.id] = docSnap.data();
                });
                
                const countEl = document.getElementById('cache-count');
                if (countEl) countEl.innerText = Object.keys(cloudCache).length;
                
                log(`â˜ï¸ é›²ç«¯å¿«å–åŒæ­¥å®Œæˆï¼Œå…± ${Object.keys(cloudCache).length} ç­†åº§æ¨™`, 'success');
                
                if (allData.length > 0) renderListOnly();
            }, (error) => {
                log(`ğŸ”¥ é›²ç«¯å¿«å–è®€å–éŒ¯èª¤: ${error.message}`, 'err');
            });
            
            // å°‡ appID å­˜ä¸‹ä¾†ä¾›å¯«å…¥æ™‚ä½¿ç”¨
            window.currentAppId = currentAppId;
        };

        function safeShow(id) { try { const el = document.getElementById(id); if (el) el.classList.remove('hidden'); } catch(e) {} }
        
        window.clearLog = function() {
            const win = document.getElementById('log-window');
            if (win) win.innerHTML = `<div class="text-yellow-400 border-b border-gray-700 pb-1 mb-1 flex justify-between sticky top-0 bg-[#0f172a] z-10"><span class="font-bold">> ç³»çµ±æ—¥èªŒ</span><span class="text-[9px] cursor-pointer hover:text-white bg-slate-700 px-2 rounded" onclick="window.clearLog()">æ¸…é™¤</span></div>`;
        };
        
        function log(msg, type='info') {
            try {
                const win = document.getElementById('log-window');
                if (!win) return;
                const color = type === 'err' ? '#f87171' : type === 'warn' ? '#facc15' : type === 'success' ? '#4ade80' : '#60a5fa';
                const time = new Date().toLocaleTimeString('zh-TW', {hour12:false});
                win.innerHTML += `<div class="log-entry" style="color:${color}">[${time}] ${msg}</div>`;
                win.scrollTop = win.scrollHeight;
            } catch(e) {}
        }

        window.initMap = function() {
            try {
                const mapEl = document.getElementById("map");
                if (!mapEl) return;
                map = new google.maps.Map(mapEl, { center: { lat: 23.6, lng: 120.9 }, zoom: 8, mapTypeControl: false });
                geocoder = new google.maps.Geocoder();
                bounds = new google.maps.LatLngBounds();
                log("ğŸ—ºï¸ Google Maps API è¼‰å…¥å®Œæˆ", "info");
            } catch (e) { log("âŒ åœ°åœ–è¼‰å…¥å¤±æ•—: " + e.message, "err"); }
        };

        function getCustomPin(color) {
            const width = 36; const height = 48;
            const svgData = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="${width}" height="${height}">
                    <path fill="${color}" stroke="#ffffff" stroke-width="2" d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0z"/>
                    <circle cx="192" cy="192" r="85" fill="#ffffff" />
                    <path fill="${color}" d="M207.3 261.2c-2.4 4.5-8.5 5.5-12.3 2L135 225.5c-3-2.8-3.9-7.1-2.2-10.9L157.4 160H122c-4.4 0-8-3.6-8-8v-16c0-4.4 3.6-8 8-8h80c5.4 0 9.4 5.2 7.9 10.4l-19.4 69.6h31.5c4.7 0 8.7 3.2 9.8 7.8 1.1 4.5-1.1 9.2-5.1 11.2l-35.4 24.2z"/>
                </svg>`;
            return {
                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svgData)}`,
                scaledSize: new google.maps.Size(width, height),
                anchor: new google.maps.Point(width/2, height)
            };
        }

        // --- 1. è®€å–è³‡æ–™èˆ‡éš±ç§ä¿è­·è™•ç† ---
        window.loadData = function() {
            const btn = document.getElementById('btn-load');
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è®€å–ä¸­...';

            const key = CONFIG.PREFILL_RAGIC_KEY;
            currentApiKey = key;

            FIELDS.NAME = document.getElementById('fid-name').value;
            FIELDS.CAT = document.getElementById('fid-cat').value;
            FIELDS.ADDR = document.getElementById('fid-addr').value;
            FIELDS.COORDS = document.getElementById('fid-coords').value;

            const server = "ap14"; // é–å®š ap14
            const url = `https://${server}.ragic.com/${CONFIG.RAGIC_PATH}?api&naming=EID&APIKey=${encodeURIComponent(key)}&callback=ragicCallback`;

            log(`ğŸ“¡ æ­£åœ¨é€£ç·šè®€å– Ragic è³‡æ–™...`, "info");
            
            window.ragicCallback = function(res) {
                if (!res || res.status === 'ERROR') {
                    log(`âŒ API è®€å–éŒ¯èª¤: ${res?.msg || 'æœªçŸ¥'}`, "err");
                    if (btn) btn.innerHTML = '<i class="fas fa-sync-alt"></i> æ‰‹å‹•é‡æ–°è®€å–';
                    return;
                }
                
                let data = Object.values(res);
                let privacyCount = 0;

                data = data.filter(item => {
                    const addr = item[FIELDS.ADDR];
                    return addr && typeof addr === 'string' && addr.trim().length > 0;
                }).map(item => {
                    const cat = item[FIELDS.CAT] || '';
                    if (cat === 'å®¶å……') {
                        const name = item[FIELDS.NAME] || '';
                        if (name.length > 0) item[FIELDS.NAME] = name.charAt(0) + 'å®…';
                        
                        const addr = item[FIELDS.ADDR] || '';
                        if (addr) {
                            const match = addr.match(/(.*?(?:è·¯|è¡—|å¤§é“)(?:[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+æ®µ)?)/);
                            if (match) {
                                item[FIELDS.ADDR] = match[1];
                            } else {
                                const idx = addr.search(/[\då··å¼„è™Ÿæ¨“]/);
                                if (idx !== -1) item[FIELDS.ADDR] = addr.substring(0, idx);
                            }
                        }
                        privacyCount++;
                    }
                    return item;
                });
                
                allData = data;
                log(`âœ… è®€å– ${allData.length} ç­†è³‡æ–™ (éš±è— ${privacyCount} ç­†å®¶å……)`, "success");

                if (btn) btn.innerHTML = '<i class="fas fa-sync-alt"></i> æ‰‹å‹•é‡æ–°è®€å–';
                safeShow('render-panel');
                renderListOnly(); 

                // ğŸš€ è‡ªå‹•æª¢æŸ¥ï¼šè‹¥æœ‰å°šæœªè§£æçš„æ–°åœ°å€ï¼Œè‡ªå‹•è§¸ç™¼ã€Œè§£æä¸¦ä¸Šå‚³ã€
                let needsSync = false;
                for (let i = 0; i < allData.length; i++) {
                    const coordsRaw = allData[i][FIELDS.COORDS];
                    const docId = allData[i][FIELDS.NAME] || allData[i]._ragicId;
                    const hasOriginalCoords = coordsRaw && coordsRaw.includes(',') && !isNaN(parseFloat(coordsRaw.split(',')[0]));
                    const hasCache = !!cloudCache[docId];
                    if (!hasOriginalCoords && !hasCache) {
                        needsSync = true;
                        break;
                    }
                }
                
                if (needsSync) {
                    log(`ğŸ”„ ç™¼ç¾æœªè§£æçš„æ–°åœ°å€ï¼Œè‡ªå‹•å•Ÿå‹•è§£æèˆ‡åŒæ­¥...`, "warn");
                    setTimeout(() => { window.startDynamicMapping(); }, 1500);
                }
            };

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => {
                log("âŒ é€£ç·šä¸­æ–· (Network Error)", "err");
                if (btn) btn.innerHTML = '<i class="fas fa-sync-alt"></i> æ‰‹å‹•é‡æ–°è®€å–';
            };
            document.body.appendChild(script);
        };

        // ç¹ªè£½åˆå§‹åˆ—è¡¨ä¸¦åˆä½µé›²ç«¯å¿«å–
        function renderListOnly() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            
            markers.forEach(m => m.setMap(null));
            markers = [];
            bounds = new google.maps.LatLngBounds();

            allData.forEach((item) => {
                const id = item._ragicId;
                const name = item[FIELDS.NAME] || '(ç„¡åç¨±)';
                const addr = item[FIELDS.ADDR];
                const cat = item[FIELDS.CAT] || 'æœªåˆ†é¡';
                const coordsRaw = item[FIELDS.COORDS];
                
                const color = COLORS[cat] || COLORS['default'];
                
                const hasOriginalCoords = coordsRaw && coordsRaw.includes(',') && !isNaN(parseFloat(coordsRaw.split(',')[0]));
                
                const docId = name || id; 
                const cacheData = cloudCache[docId];
                const hasCache = !!cacheData;
                
                const card = document.createElement('div');
                card.className = `card`;
                card.id = `card-${id}`;
                card.style.borderLeftWidth = '4px';
                card.style.borderLeftColor = color;
                
                let statusHtml = '';
                if (hasOriginalCoords) {
                    statusHtml = `<div class="mt-1 text-[10px] text-green-600 font-bold"><i class="fas fa-check"></i> åŸæœ‰åº§æ¨™</div>`;
                } else if (hasCache) {
                    statusHtml = `<div class="mt-1 text-[10px] text-blue-500 font-bold"><i class="fas fa-cloud"></i> å‘½ä¸­é›²ç«¯å¿«å–</div>`;
                } else {
                    statusHtml = `<div id="status-${id}" class="mt-1 text-[10px] text-slate-400 font-bold"><i class="fas fa-hourglass-half"></i> å¾…è§£æ (æœªå¿«å–)</div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded text-white shadow-sm" style="background:${color}">${cat}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-[13px] leading-tight">${name}</h3>
                    <p class="text-[11px] text-gray-500 mt-1 truncate"><i class="fas fa-shield-alt text-green-500 mr-1" title="éš±ç§ä¿è­·"></i>${addr}</p>
                    ${statusHtml}
                `;
                
                list.appendChild(card);

                if (hasOriginalCoords) {
                    const [lat, lng] = coordsRaw.split(',').map(Number);
                    addMarkerToMap(id, name, lat, lng, color, cat);
                } else if (hasCache && cacheData.coords) {
                    const [lat, lng] = cacheData.coords.split(',').map(Number);
                    addMarkerToMap(id, name, lat, lng, color, cat);
                }
            });
            
            if (markers.length > 0) map.fitBounds(bounds);
        }

        // --- 2. å•Ÿå‹•å‹•æ…‹è§£æä¸¦ä¸Šå‚³ Firebase ---
        window.startDynamicMapping = async function() {
            if (!geocoder) return alert("åœ°åœ–å…ƒä»¶æœªè¼‰å…¥");
            if (!currentUser) return alert("Firebase æœªç™»å…¥ï¼Œç„¡æ³•å¯«å…¥é›²ç«¯ã€‚è«‹ç¢ºèª Firebase è¨­å®šã€‚");
            
            const btn = document.getElementById('btn-render');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è§£æä¸¦åŒæ­¥è‡³é›²ç«¯...';

            log(`ğŸš€ å•Ÿå‹•æ™ºèƒ½è§£æ (è‡ªå‹•è·³éé›²ç«¯å·²æœ‰é …ç›®)...`, "warn");

            let processCount = 0;
            let skipCount = 0;
            let failCount = 0;

            for (let i = 0; i < allData.length; i++) {
                const item = allData[i];
                const id = item._ragicId;
                const name = item[FIELDS.NAME] || 'æœªå‘½å';
                const addr = item[FIELDS.ADDR];
                const coordsRaw = item[FIELDS.COORDS];
                const cat = item[FIELDS.CAT] || 'æœªåˆ†é¡';
                const color = COLORS[cat] || COLORS['default'];

                const hasOriginalCoords = coordsRaw && coordsRaw.includes(',') && !isNaN(parseFloat(coordsRaw.split(',')[0]));
                const docId = name || id;
                const hasCache = !!cloudCache[docId];
                
                if (!hasOriginalCoords && !hasCache) {
                    const statusEl = document.getElementById(`status-${id}`);
                    if (statusEl) statusEl.innerHTML = `<span class="text-yellow-500"><i class="fas fa-spinner fa-spin"></i> è«‹æ±‚ Google API...</span>`;

                    let success = false;
                    let retries = 0;

                    while (!success && retries < 3) {
                        try {
                            log(`ğŸ” æŸ¥è©¢ [${i+1}/${allData.length}]: ${addr}`, "info");
                            
                            const loc = await new Promise((resolve, reject) => {
                                geocoder.geocode({ address: addr }, (res, status) => {
                                    if (status === 'OK' && res.length > 0) resolve(res[0].geometry.location);
                                    else reject(status);
                                });
                            });

                            const lat = loc.lat();
                            const lng = loc.lng();
                            const coordsStr = `${lat},${lng}`;

                            // âœ… å¯«å…¥ Firebase Firestore
                            const targetAppId = window.currentAppId || 'ev-map-production';
                            const docRef = doc(db, 'artifacts', targetAppId, 'public', 'data', 'coords_cache', docId);
                            await setDoc(docRef, {
                                coords: coordsStr,
                                address: addr,
                                updatedAt: new Date().toISOString()
                            });

                            addMarkerToMap(id, name, lat, lng, color, cat);
                            if (statusEl) statusEl.innerHTML = `<span class="text-blue-500 font-bold"><i class="fas fa-cloud-upload-alt"></i> å·²ä¸Šå‚³é›²ç«¯</span>`;
                            
                            success = true;
                            processCount++;
                        } catch (e) {
                            if (e === 'OVER_QUERY_LIMIT') {
                                retries++;
                                log(`âš ï¸ é »ç‡é™åˆ¶ï¼Œç­‰å¾…é‡è©¦ (${retries}/3)...`, "warn");
                                await new Promise(r => setTimeout(r, 2000));
                            } else {
                                log(`âŒ å¤±æ•— (${addr}): ç„¡æ³•å®šä½`, "err");
                                if (statusEl) statusEl.innerHTML = `<span class="text-red-500 font-bold"><i class="fas fa-exclamation-triangle"></i> è§£æå¤±æ•—</span>`;
                                failCount++;
                                break;
                            }
                        }
                    }

                    await new Promise(r => setTimeout(r, 800)); 
                } else {
                    skipCount++;
                }
            }

            log(`ğŸ‰ çµæŸï¼æ–°è§£æä¸¦ä¸Šå‚³ ${processCount} ç­†ï¼Œå¤±æ•— ${failCount} ç­†ï¼Œå¾é›²ç«¯è·³é ${skipCount} ç­†ã€‚`, "success");
            btn.innerHTML = '<i class="fas fa-satellite-dish"></i> 2. è§£ææ–°åœ°å€ä¸¦ä¸Šå‚³';
            btn.disabled = false;
            
            if (markers.length > 0) map.fitBounds(bounds);
        }

        // å…±ç”¨å‡½å¼ï¼šåŠ åœ–é‡˜åˆ°åœ°åœ– (Z-Index ç½®é ‚å„ªåŒ–)
        function addMarkerToMap(id, name, lat, lng, color, cat) {
            let markerZIndex = 1;
            if (cat === 'å°ˆæ¡ˆ' || cat === 'ç¤¾å€') {
                markerZIndex = 1000;
            } else if (cat === 'å®¶å……') {
                markerZIndex = 10;
            }

            const marker = new google.maps.Marker({
                position: {lat, lng}, map: map, title: name, icon: getCustomPin(color), zIndex: markerZIndex
            });
            const clickFn = () => { map.panTo({lat, lng}); map.setZoom(16); };
            marker.addListener('click', clickFn);
            
            const card = document.getElementById(`card-${id}`);
            if (card) { card.onclick = clickFn; card.classList.add('cursor-pointer'); }
            
            markers.push(marker);
            bounds.extend({lat, lng});
        }

        // --- é é¢å•Ÿå‹•ç¨‹åº ---
        window.addEventListener('DOMContentLoaded', () => {
            initFirebase(); 
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.MAP_KEY}&callback=initMap&language=zh-TW`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        });

    </script>
</body>
</html>
